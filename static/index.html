<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beka MultiPlace - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1117;
            --bg-secondary: #1a1d27;
            --bg-card: #222632;
            --bg-card-hover: #2a2f3e;
            --bg-input: #181b24;
            --border: #2d3348;
            --border-focus: #f05d23;
            --text-primary: #e8eaf0;
            --text-secondary: #8b90a0;
            --text-muted: #5a5f72;
            --accent: #f05d23;
            --accent-hover: #ff7340;
            --accent-glow: rgba(240, 93, 35, 0.25);
            --success: #22c55e;
            --success-bg: rgba(34, 197, 94, 0.12);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.12);
            --error: #ef4444;
            --error-bg: rgba(239, 68, 68, 0.12);
            --info: #3b82f6;
            --info-bg: rgba(59, 130, 246, 0.12);
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-xs: 6px;
            --transition: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 42px;
            height: 42px;
            background: #f0ece6;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            overflow: hidden;
            padding: 4px;
        }

        .header-title h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .header-title span {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-input);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.processing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
        }

        /* NAVIGATION TABS */
        .nav-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            gap: 0;
        }

        .nav-tab {
            padding: 14px 24px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .nav-tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.03); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .nav-tab i { font-size: 14px; }

        /* MAIN CONTENT */
        .main-content {
            padding: 24px 32px;
            max-width: 1440px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* GRID */
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
        }

        .card:hover { border-color: var(--border-focus); box-shadow: var(--shadow); }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .card-icon.orange { background: var(--accent-glow); color: var(--accent); }
        .card-icon.green { background: var(--success-bg); color: var(--success); }
        .card-icon.blue { background: var(--info-bg); color: var(--info); }
        .card-icon.yellow { background: var(--warning-bg); color: var(--warning); }

        .card-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        .card-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* STAT CARDS */
        .stat-mini {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-input);
            border-radius: var(--radius-xs);
        }

        .stat-mini-icon {
            font-size: 18px;
            opacity: 0.7;
        }

        .stat-mini-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-mini-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* BUTTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #ff7340);
            color: white;
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 24px var(--accent-glow);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }

        .btn-danger {
            background: var(--error-bg);
            color: var(--error);
            border: 1px solid rgba(239,68,68,0.2);
        }

        .btn-danger:hover { background: rgba(239,68,68,0.2); }

        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-lg { padding: 14px 28px; font-size: 15px; }

        /* PROCESS BUTTON SPECIAL */

        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
            display: none;
        }

        .progress-bar.active { display: block; }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #ff8c42);
            border-radius: 2px;
            animation: progress-indeterminate 1.5s infinite;
            width: 40%;
        }

        @keyframes progress-indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }

        /* TABLES */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table-header h3 {
            font-size: 14px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-input);
        }

        td {
            padding: 12px 20px;
            font-size: 13px;
            border-bottom: 1px solid rgba(45, 51, 72, 0.5);
        }

        tr:hover td { background: rgba(255, 255, 255, 0.02); }

        .badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-pdf { background: var(--error-bg); color: var(--error); }
        .badge-zip { background: var(--info-bg); color: var(--info); }
        .badge-success { background: var(--success-bg); color: var(--success); }
        .badge-warning { background: var(--warning-bg); color: var(--warning); }

        /* LOG PANEL */
        .log-panel {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 500px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 6px 16px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid rgba(45, 51, 72, 0.3);
            line-height: 1.5;
        }

        .log-entry:hover { background: rgba(255, 255, 255, 0.02); }
        .log-time { color: var(--text-muted); white-space: nowrap; min-width: 60px; }
        .log-msg { color: var(--text-secondary); word-break: break-all; }
        .log-entry.success .log-msg { color: var(--success); }
        .log-entry.warning .log-msg { color: var(--warning); }
        .log-entry.error .log-msg { color: var(--error); }
        .log-entry.info .log-msg { color: var(--text-secondary); }

        .log-empty {
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
        }

        /* UPLOAD ZONE */
        /* HELP BUTTON */
        .btn-help {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .btn-help:hover {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(240, 93, 35, 0.1);
        }

        /* HELP MODAL */
        .modal-ajuda {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }
        .modal-ajuda-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            width: 520px;
            max-width: 92vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-ajuda-content h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-ajuda-content h3 i { color: var(--accent); }
        .modal-ajuda-content p, .modal-ajuda-content li {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 8px;
        }
        .modal-ajuda-content ol, .modal-ajuda-content ul {
            padding-left: 20px;
            margin-bottom: 12px;
        }
        .modal-ajuda-content .destaque {
            background: rgba(240, 93, 35, 0.1);
            border-left: 3px solid var(--accent);
            padding: 10px 14px;
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
            margin: 12px 0;
            font-size: 12px;
            color: var(--text-primary);
        }

        .card.dragover {
            border-color: var(--accent) !important;
            background: rgba(240, 93, 35, 0.08) !important;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--bg-card);
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(240, 93, 35, 0.05);
        }
        .upload-zone i { font-size: 24px; color: var(--text-muted); margin-bottom: 8px; }
        .upload-zone h4 { font-size: 13px; margin: 0; }
        .upload-zone p { font-size: 11px; color: var(--text-muted); margin: 0; }

        /* FILE LIST */
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .file-item:hover { border-color: var(--text-muted); }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .file-icon.pdf { background: var(--error-bg); color: var(--error); }
        .file-icon.zip { background: var(--info-bg); color: var(--info); }
        .file-icon.xlsx { background: var(--success-bg); color: var(--success); }

        .file-name { font-size: 13px; font-weight: 500; }
        .file-size { font-size: 11px; color: var(--text-muted); }

        /* CONFIG FORM */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* LOJA CARDS */
        .loja-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
        }

        .loja-card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .loja-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .loja-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--accent), #ff8c42);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 800;
            color: white;
        }

        .loja-name {
            font-size: 15px;
            font-weight: 700;
        }

        .loja-cnpj {
            font-size: 11px;
            color: var(--text-muted);
            font-family: monospace;
        }

        .loja-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .loja-stat {
            text-align: center;
            padding: 10px 8px;
            background: var(--bg-input);
            border-radius: var(--radius-xs);
        }

        .loja-stat-value {
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
        }

        .loja-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .loja-actions {
            display: flex;
            gap: 8px;
        }

        .loja-actions .btn { flex: 1; justify-content: center; }

        /* SECTION TITLE */
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i { color: var(--accent); }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p { font-size: 13px; }

        /* TOAST */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
        }

        .toast.success { background: #16a34a; color: white; }
        .toast.error { background: #dc2626; color: white; }
        .toast.warning { background: #d97706; color: white; }
        .toast.info { background: #2563eb; color: white; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* RESULTADO RESUMO */
        .resultado-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* SPINNER */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* TOOLTIP */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 11px;
            border-radius: var(--radius-xs);
            white-space: nowrap;
            border: 1px solid var(--border);
            z-index: 10;
            margin-bottom: 6px;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="header-left">
        <div class="logo"><img src="/static/logo.svg" alt="Beka" style="width:100%; height:100%; object-fit:contain; border-radius:inherit;"></div>
        <div class="header-title">
            <h1>Beka MultiPlace</h1>
            <span>Processador de Etiquetas &amp; DANFE</span>
        </div>
    </div>
    <div class="header-actions">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Pronto</span>
        </div>
        <span id="planoBadge" style="padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600; background:#2d1b4e; color:#a78bfa; display:none;">Free</span>
        <button id="btnAssinar" class="btn btn-sm" style="background:linear-gradient(135deg,#8b5cf6,#6d28d9); color:#fff; display:none;" onclick="assinarPremium()">
            <i class="fas fa-crown"></i> Assinar Premium
        </button>
        <button class="btn btn-secondary btn-sm" onclick="sair()" title="Sair">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
    </div>
</header>

<!-- NAV TABS -->
<nav class="nav-tabs">
    <div class="nav-tab active" data-tab="painel" onclick="trocarTab('painel')">
        <i class="fas fa-tags"></i> Etiquetas
    </div>
    <div class="nav-tab" data-tab="resultados" onclick="trocarTab('resultados')">
        <i class="fas fa-store"></i> Resultados
    </div>
    <div class="nav-tab" data-tab="lucro" onclick="trocarTab('lucro')">
        <i class="fas fa-dollar-sign"></i> Lucro
    </div>
    <div class="nav-tab" data-tab="automacao" onclick="trocarTab('automacao')">
        <i class="fas fa-robot"></i> Automacao
    </div>
    <div class="nav-tab" data-tab="admin" onclick="trocarTab('admin')" id="navAdmin" style="display:none;">
        <i class="fas fa-shield-alt"></i> Admin
    </div>
    <div class="nav-tab" data-tab="shopee-expert" onclick="trocarTab('shopee-expert')" style="margin-left:auto;">
        <i class="fas fa-magic"></i> Shopee Expert
    </div>
</nav>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- MAIN CONTENT -->
<div class="main-content">

    <!-- ==================== PAINEL ==================== -->
    <div class="tab-content active" id="tab-painel">

        <!-- Upload + Processar (1 card horizontal) -->
        <div class="card" style="display:flex; align-items:center; gap:10px; padding:10px 14px; margin-bottom:12px;"
             id="uploadZone"
             ondragover="event.preventDefault(); this.classList.add('dragover')"
             ondragleave="this.classList.remove('dragover')"
             ondrop="handleDrop(event)">
            <div onclick="document.getElementById('fileInput').click()" style="cursor:pointer; display:flex; align-items:center; gap:6px; padding:6px 12px; border:1px dashed var(--border); border-radius:var(--radius-xs); color:var(--text-secondary); font-size:12px; flex-shrink:0; transition:var(--transition);" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
                <i class="fas fa-cloud-upload-alt" style="color:var(--accent);"></i> Upload
            </div>
            <input type="file" id="fileInput" hidden multiple accept=".pdf,.xlsx,.xls" onchange="handleUpload(this.files)">
            <div class="progress-bar" id="progressBar" style="flex:1;">
                <div class="progress-bar-fill"></div>
            </div>
            <button class="btn btn-primary btn-sm" id="btnProcessar" onclick="processar()" disabled style="font-size:11px; padding:6px 12px; flex-shrink:0;">
                <i class="fas fa-play"></i> Processar
            </button>
            <button class="btn btn-sm" id="btnNovoLote" onclick="novoLote()" style="background:var(--warning); color:#000; border:none; cursor:pointer; font-weight:600; font-size:11px; padding:6px 12px; flex-shrink:0;">
                <i class="fas fa-broom"></i> Novo Lote
            </button>
        </div>
        <div id="avisoUpload" style="display:none; margin-bottom:8px; padding:6px 12px; border-radius:6px; font-size:12px;"></div>

        <!-- Stats Cards -->
        <div class="grid grid-4" id="statsCards" style="margin-bottom:16px;">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">PDFs</span>
                    <div class="card-icon orange"><i class="fas fa-file-pdf"></i></div>
                </div>
                <div class="card-value" id="statPdfs">-</div>
                <div class="card-sub">Arquivos de etiquetas</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">XLSX</span>
                    <div class="card-icon blue"><i class="fas fa-file-excel"></i></div>
                </div>
                <div class="card-value" id="statZips">-</div>
                <div class="card-sub">Planilhas de empacotamento</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Etiquetas</span>
                    <div class="card-icon green"><i class="fas fa-tag"></i></div>
                </div>
                <div class="card-value" id="statEtiquetas">-</div>
                <div class="card-sub">Total processadas</div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Lojas</span>
                    <div class="card-icon yellow"><i class="fas fa-store"></i></div>
                </div>
                <div class="card-value" id="statLojas">-</div>
                <div class="card-sub">Vendedores identificados</div>
            </div>
        </div>

        <!-- 2 colunas: Resultado compacto | Config + Agrupamento -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">

            <!-- Coluna esquerda: Ultimo Processamento + Log -->
            <div>
                <h3 class="section-title" style="font-size:13px; margin-bottom:8px;"><i class="fas fa-clock"></i> Ultimo Processamento</h3>
                <div id="ultimoResultado">
                    <div style="padding:16px; text-align:center; color:var(--text-muted); font-size:12px;">
                        <i class="fas fa-inbox" style="font-size:20px; margin-bottom:6px; display:block; opacity:0.5;"></i>
                        Nenhum processamento realizado
                    </div>
                </div>
                <h3 class="section-title" style="font-size:13px; margin-top:12px; margin-bottom:6px;"><i class="fas fa-terminal"></i> Log</h3>
                <div id="logContainer" style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); padding:8px; max-height:120px; overflow-y:auto; font-family:monospace; font-size:10px; line-height:1.5;">
                    <div style="color:var(--text-muted);">Aguardando...</div>
                </div>
            </div>

            <!-- Coluna direita: Config + Agrupamento (1 card) -->
            <div class="card" style="padding:14px; display:flex; flex-direction:column; gap:10px;">
                <div class="card-header" style="margin-bottom:0;">
                    <span class="card-title"><i class="fas fa-cog"></i> Configuracoes</span>
                </div>

                <!-- Descricao geral -->
                <div style="font-size:11px; color:var(--text-muted); line-height:1.5; padding:6px 10px; background:var(--bg-input); border-radius:var(--radius-xs); border-left:3px solid var(--accent);">
                    Ajuste as dimensoes da etiqueta impressa (mm), margens internas (pt), tamanho da fonte dos produtos e como o nome do produto aparece na etiqueta.
                </div>

                <!-- Dimensoes e margens -->
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:11px;">
                    <label style="display:flex; align-items:center; gap:3px; color:var(--text-secondary);" title="Largura da etiqueta em milimetros (padrao: 150mm)">Larg
                        <input class="form-input" id="cfgLargura" type="number" min="50" max="300" style="width:48px; padding:3px 4px; font-size:11px;">
                    </label>
                    <label style="display:flex; align-items:center; gap:3px; color:var(--text-secondary);" title="Altura da etiqueta em milimetros (padrao: 230mm)">Alt
                        <input class="form-input" id="cfgAltura" type="number" min="50" max="400" style="width:48px; padding:3px 4px; font-size:11px;">
                    </label>
                    <span style="color:var(--border);">|</span>
                    <label style="display:flex; align-items:center; gap:2px; color:var(--text-muted);" title="Margem esquerda (pt)">E<input class="form-input" id="cfgMargemEsq" type="number" min="0" max="50" style="width:34px; padding:3px; font-size:11px;"></label>
                    <label style="display:flex; align-items:center; gap:2px; color:var(--text-muted);" title="Margem direita (pt)">D<input class="form-input" id="cfgMargemDir" type="number" min="0" max="50" style="width:34px; padding:3px; font-size:11px;"></label>
                    <label style="display:flex; align-items:center; gap:2px; color:var(--text-muted);" title="Margem superior (pt)">T<input class="form-input" id="cfgMargemTopo" type="number" min="0" max="50" style="width:34px; padding:3px; font-size:11px;"></label>
                    <label style="display:flex; align-items:center; gap:2px; color:var(--text-muted);" title="Margem inferior (pt)">I<input class="form-input" id="cfgMargemInf" type="number" min="0" max="50" style="width:34px; padding:3px; font-size:11px;"></label>
                    <span style="color:var(--border);">|</span>
                    <label style="display:flex; align-items:center; gap:2px; color:var(--text-secondary);" title="Tamanho da fonte da tabela de produtos (padrao: 7)">Fonte<input class="form-input" id="cfgFonteProduto" type="number" min="5" max="14" value="7" style="width:34px; padding:3px; font-size:11px;"></label>
                    <select class="form-input" id="cfgExibicaoProduto" style="padding:3px; font-size:11px;" title="Como exibir o produto na tabela: SKU, Titulo ou ambos">
                        <option value="sku">SKU</option>
                        <option value="titulo">Titulo</option>
                        <option value="ambos">SKU+Tit</option>
                    </select>
                </div>

                <!-- Legenda dos campos -->
                <div style="font-size:10px; color:var(--text-muted); line-height:1.6; padding:4px 10px;">
                    <b>Larg/Alt</b> = tamanho da etiqueta (mm) &nbsp;|&nbsp;
                    <b>E D T I</b> = margens esquerda, direita, topo, inferior (pt) &nbsp;|&nbsp;
                    <b>Fonte</b> = tamanho do texto dos produtos
                </div>

                <!-- Separador -->
                <div style="border-top:1px solid var(--border);"></div>

                <!-- Agrupamento de Lojas -->
                <div>
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
                        <div style="font-size:12px; font-weight:600; color:var(--text-secondary);"><i class="fas fa-layer-group" style="margin-right:4px;"></i> Agrupamento de Lojas</div>
                        <button class="btn btn-sm" id="btnSincronizarLojas" onclick="sincronizarLojas()" style="font-size:10px; padding:3px 8px; background:var(--info); color:#fff; border:none; cursor:pointer; border-radius:var(--radius-xs);" title="Escaneia os PDFs enviados para identificar as lojas sem precisar processar tudo">
                            <i class="fas fa-sync-alt"></i> Sincronizar Lojas
                        </button>
                    </div>
                    <div style="font-size:10px; color:var(--text-muted); margin-bottom:8px; line-height:1.4; padding:4px 10px; background:var(--bg-input); border-radius:var(--radius-xs); border-left:3px solid var(--info);">
                        Agrupe 2 ou mais lojas para gerar um PDF/XLSX unificado. Clique em <b>Sincronizar Lojas</b> para carregar as lojas dos PDFs enviados, ou elas aparecem automaticamente apos processar.
                    </div>
                    <div id="listaGrupos" style="margin-bottom:8px;"></div>
                    <!-- Aviso de grupo nao salvo -->
                    <div id="avisoGrupoNaoSalvo" style="display:none; padding:6px 10px; margin-bottom:8px; background:rgba(245,158,11,0.1); border:1px solid rgba(245,158,11,0.3); border-radius:var(--radius-xs); font-size:11px; color:var(--warning); align-items:center; gap:6px;">
                        <i class="fas fa-exclamation-triangle"></i> <span>Lojas selecionadas sem grupo salvo. Adicione o grupo ou desmarque as lojas antes de processar.</span>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="flex:1; min-width:120px;">
                            <label style="font-size:10px; color:var(--text-muted); display:block; margin-bottom:2px;">Lojas (2+)</label>
                            <div id="novoGrupoLojas" style="display:flex; flex-wrap:wrap; gap:4px; padding:4px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-xs); min-height:28px; font-size:10px;">
                                <span style="color:var(--text-muted);">Envie PDFs e clique em Sincronizar</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input class="form-input" id="novoGrupoNome" type="text" placeholder="Nome do grupo" style="flex:1; font-size:11px; padding:4px 6px;">
                            <button class="btn btn-primary btn-sm" onclick="adicionarGrupo()" style="font-size:10px; padding:4px 10px; white-space:nowrap;" title="Salvar grupo com as lojas selecionadas">
                                <i class="fas fa-save" style="margin-right:4px;"></i> Salvar Grupo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Separador -->
                <div style="border-top:1px solid var(--border);"></div>

                <!-- Limpar -->
                <button class="btn btn-danger btn-sm" onclick="limparSaida()" style="font-size:11px; padding:5px 10px; align-self:flex-start;" title="Remove todos os arquivos gerados na pasta de saida">
                    <i class="fas fa-trash-alt"></i> Limpar Pasta de Saida
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== RESULTADOS ==================== -->
    <div class="tab-content" id="tab-resultados">
        <!-- Resumo Geral -->
        <div id="resumoGeral" style="margin-bottom:24px;"></div>

        <h3 class="section-title"><i class="fas fa-store"></i> Resultados por Loja</h3>
        <div id="resultadosLojas">
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>Nenhum resultado ainda</h3>
                <p>Processe as etiquetas para ver os resultados aqui</p>
            </div>
        </div>

        <!-- Barra de Agrupamento -->
        <div id="agruparBar" style="display:none; margin-top:20px; padding:20px; background:linear-gradient(135deg, rgba(59,130,246,0.08), rgba(59,130,246,0.04)); border:1px solid rgba(59,130,246,0.2); border-radius:var(--radius); align-items:center; gap:16px;">
            <div style="flex:1; display:flex; align-items:center; gap:12px;">
                <i class="fas fa-layer-group" style="font-size:20px; color:var(--info);"></i>
                <div>
                    <div style="font-weight:600; font-size:14px;">Agrupar Lojas Selecionadas</div>
                    <div style="font-size:12px; color:var(--text-secondary);" id="agruparInfo">Selecione 2+ lojas</div>
                </div>
            </div>
            <input class="form-input" id="nomeAgrupamento" type="text" placeholder="Nome do grupo (opcional)" style="width:200px; flex:none;">
            <button class="btn btn-primary" onclick="gerarAgrupado()">
                <i class="fas fa-layer-group"></i> Gerar Agrupado
            </button>
        </div>
    </div>

    <!-- ==================== ABA LUCRO ==================== -->
    <div class="tab-content" id="tab-lucro">
        <h3 class="section-title"><i class="fas fa-dollar-sign"></i> Calculadora de Lucro</h3>

        <!-- Upload de ZIP/XML para lucro -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-file-archive"></i> Arquivos de Notas Fiscais</span>
                <button class="btn btn-secondary btn-sm" onclick="limparUploadsLucro()" id="btnLimparLucro" style="display:none; font-size:11px;">
                    <i class="fas fa-trash-alt"></i> Limpar
                </button>
            </div>
            <div class="upload-zone" id="uploadZoneLucro"
                 ondragover="event.preventDefault(); this.classList.add('dragover')"
                 ondragleave="this.classList.remove('dragover')"
                 ondrop="handleDropLucro(event)"
                 onclick="document.getElementById('fileInputLucro').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h4>Arraste ZIPs ou XMLs aqui</h4>
                <p>Aceita arquivos ZIP (notas fiscais XML) e XML avulsos</p>
            </div>
            <input type="file" id="fileInputLucro" hidden multiple accept=".zip,.xml" onchange="handleUploadLucro(this.files)">
            <div id="listaArquivosLucro" style="margin-top:12px;"></div>
        </div>

        <!-- Parametros de calculo -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-calculator"></i> Parametros de Calculo</span>
                <button class="btn-help" onclick="mostrarAjuda('calculadora')" title="Como funciona a calculadora">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:16px;">
                Parametros para o calculo de lucro. O match de SKU busca o SKU completo ou o maior prefixo correspondente.
            </p>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">% Valor Declarado</label>
                    <input class="form-input" id="cfgPercDeclarado" type="number" min="1" max="100" value="100" style="width:120px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Taxa Shopee (%)</label>
                    <input class="form-input" id="cfgTaxaShopee" type="number" min="0" max="100" step="0.5" value="18" style="width:120px;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Aliquota (%)</label>
                    <input class="form-input" id="cfgImpostoSimples" type="number" min="0" max="100" step="0.5" value="4" style="width:120px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Custo Fixo (R$)</label>
                    <input class="form-input" id="cfgCustoFixo" type="number" min="0" step="0.50" value="3" style="width:120px;">
                </div>
            </div>
            <div class="form-group" style="margin-top:12px;">
                <label class="form-label">Planilha de Custos (.xlsx)</label>
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('inputCustos').click()">
                        <i class="fas fa-upload"></i> Upload Planilha
                    </button>
                    <a class="btn btn-secondary btn-sm" href="/api/exemplo-custos" target="_blank">
                        <i class="fas fa-download"></i> Baixar Exemplo
                    </a>
                    <input type="file" id="inputCustos" accept=".xlsx" style="display:none;" onchange="uploadCustos(this)">
                    <span id="lblPlanilhaCustos" style="font-size:12px; color:var(--text-muted);">Nenhuma planilha carregada</span>
                </div>
                <span style="font-size:11px; color:var(--text-muted); margin-top:4px; display:block;">Formato: Coluna A = SKU, Coluna B = Custo unitario</span>
            </div>

            <!-- Config por loja -->
            <div id="configLucroLojas" style="margin-top:20px; display:none;">
                <div style="font-size:13px; font-weight:600; margin-bottom:12px; color:var(--text-secondary); display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <span><i class="fas fa-store"></i> Configuracao Individual por Loja</span>
                    <span style="font-size:11px; font-weight:400; color:var(--text-muted);">Deixe vazio para usar o padrao global</span>
                    <button class="btn btn-secondary btn-sm" onclick="atualizarLojasLucro()" id="btnAtualizarLojasLucro" style="font-size:11px; margin-left:auto;">
                        <i class="fas fa-sync-alt"></i> Atualizar Lojas
                    </button>
                </div>
                <div id="tabelaConfigLojas" style="overflow-x:auto;"></div>
                <button class="btn btn-primary btn-sm" onclick="salvarConfigLucroLojas()" style="margin-top:12px;">
                    <i class="fas fa-save"></i> Salvar Config Lojas
                </button>
            </div>
        </div>

        <!-- Botao gerar lucro -->
        <div style="margin-bottom:20px;">
            <button class="btn btn-lg" id="btnLucro" onclick="gerarLucro()" style="background: #28a745; color: white; border: none; cursor: pointer; width:100%;">
                <i class="fas fa-dollar-sign"></i> Gerar Resumo de Lucro
            </button>
        </div>

        <!-- Resultado do lucro -->
        <div id="resumoLucro" style="margin-bottom:24px;"></div>
    </div>

    <!-- ==================== AUTOMACAO ==================== -->
    <div class="tab-content" id="tab-automacao">
        <h3 class="section-title"><i class="fas fa-robot"></i> Automacao - UpSeller + WhatsApp</h3>

        <!-- UPSELLER CONFIG -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-plug"></i> Conexao UpSeller</span>
                <span id="upsellerStatus" class="badge" style="font-size:11px;">Desconectado</span>
            </div>
            <div id="upsellerDesconectado" style="text-align:center; padding:15px 0;">
                <p style="color:var(--text-secondary); font-size:13px; margin-bottom:15px;">
                    Clique abaixo para abrir o UpSeller e fazer login.<br>
                    <span style="font-size:11px; opacity:0.7;">A sessao fica salva por 14 dias automaticamente.</span>
                </p>
                <button onclick="conectarUpseller()" style="
                    background: linear-gradient(135deg, #2196F3, #1565C0);
                    color: white; border: none; padding: 14px 35px; border-radius: 10px;
                    font-size: 15px; font-weight: 600; cursor: pointer;
                    box-shadow: 0 4px 15px rgba(33,150,243,0.4);
                    transition: all 0.3s ease; display:inline-flex; align-items:center; gap:10px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(33,150,243,0.5)'"
                   onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.4)'">
                    <i class="fas fa-sign-in-alt" style="font-size:18px;"></i> Conectar ao UpSeller
                </button>
            </div>
            <div id="upsellerConectado" style="display:none; text-align:center; padding:10px 0;">
                <p style="color:#25D366; font-size:14px; font-weight:600; margin-bottom:10px;">
                    <i class="fas fa-check-circle"></i> Conectado ao UpSeller
                </p>
                <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                    <button class="btn btn-secondary" onclick="testarUpsellerConexao()" style="font-size:12px;">
                        <i class="fas fa-wifi"></i> Verificar Sessao
                    </button>
                    <button class="btn btn-secondary" onclick="reconectarUpseller()" style="font-size:12px;">
                        <i class="fas fa-redo"></i> Reconectar
                    </button>
                    <button class="btn btn-primary" id="btnSincronizar" onclick="sincronizarUpseller()" style="font-size:12px;">
                        <i class="fas fa-sync-alt"></i> Sincronizar Agora
                    </button>
                </div>
                <!-- Barra de progresso da sincronizacao -->
                <div id="syncProgressContainer" style="display:none; margin-top:12px; padding:0 10px;">
                    <div style="background:var(--bg-tertiary); border-radius:8px; overflow:hidden; height:22px; position:relative;">
                        <div id="syncProgressBar" style="
                            height:100%; border-radius:8px; transition: width 0.5s ease;
                            background: linear-gradient(90deg, #2196F3, #1565C0);
                            width:0%; display:flex; align-items:center; justify-content:center;
                        ">
                            <span id="syncProgressPercent" style="color:white; font-size:10px; font-weight:600; text-shadow:0 1px 2px rgba(0,0,0,0.3);"></span>
                        </div>
                    </div>
                    <p id="syncProgressText" style="font-size:11px; color:var(--text-secondary); margin-top:4px; text-align:center;"></p>
                </div>
            </div>
            <p id="upsellerUltimaSync" style="font-size:11px; color:var(--text-secondary); margin-top:8px; text-align:center;"></p>
        </div>

        <!-- WHATSAPP CONFIG -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fab fa-whatsapp"></i> Conexao WhatsApp</span>
                <span id="whatsappStatus" class="badge" style="font-size:11px;">Desconectado</span>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-success" onclick="verificarWhatsApp()" style="font-size:12px; background:#25D366;">
                    <i class="fab fa-whatsapp"></i> Verificar Status
                </button>
                <button class="btn btn-secondary" onclick="mostrarQRWhatsApp()" style="font-size:12px;">
                    <i class="fas fa-qrcode"></i> Ver QR Code
                </button>
                <div style="flex:1; min-width:200px; display:flex; gap:8px; align-items:center;">
                    <input class="form-input" id="whatsappTesteTel" placeholder="5511999999999" style="font-size:12px;">
                    <button class="btn btn-secondary" onclick="enviarTesteWhatsApp()" style="font-size:12px; white-space:nowrap;">
                        <i class="fas fa-paper-plane"></i> Teste
                    </button>
                </div>
            </div>
            <div id="whatsappQRContainer" style="display:none; margin-top:15px; text-align:center;">
                <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">Escaneie o QR code com seu WhatsApp:</p>
                <img id="whatsappQRImage" style="max-width:280px; border-radius:8px; border:1px solid var(--border);">
            </div>
        </div>

        <!-- CONTATOS POR LOJA -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-address-book"></i> Contatos por Loja</span>
                <button class="btn btn-primary" onclick="mostrarFormContato()" style="font-size:11px; padding:4px 10px;">
                    <i class="fas fa-plus"></i> Adicionar
                </button>
            </div>
            <!-- Formulario de adicionar -->
            <div id="formContato" style="display:none; margin-bottom:15px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid var(--border);">
                <div class="form-row" style="flex-wrap:wrap; gap:8px;">
                    <div class="form-group" style="flex:1; min-width:150px;">
                        <label class="form-label">Loja (CNPJ)</label>
                        <input class="form-input" id="contatoCNPJ" placeholder="12.345.678/0001-99" style="font-size:12px;">
                    </div>
                    <div class="form-group" style="flex:1; min-width:150px;">
                        <label class="form-label">Nome da Loja</label>
                        <input class="form-input" id="contatoLoja" placeholder="Loja Example" style="font-size:12px;">
                    </div>
                    <div class="form-group" style="flex:1; min-width:150px;">
                        <label class="form-label">WhatsApp</label>
                        <input class="form-input" id="contatoTel" placeholder="5511999999999" style="font-size:12px;">
                    </div>
                    <div class="form-group" style="flex:1; min-width:120px;">
                        <label class="form-label">Nome Contato</label>
                        <input class="form-input" id="contatoNome" placeholder="Joao" style="font-size:12px;">
                    </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn btn-primary" onclick="salvarContato()" style="font-size:11px;">
                        <i class="fas fa-check"></i> Salvar
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('formContato').style.display='none'" style="font-size:11px;">
                        Cancelar
                    </button>
                </div>
            </div>
            <!-- Tabela de contatos -->
            <div id="tabelaContatos" style="overflow-x:auto;">
                <p style="font-size:12px; color:var(--text-secondary);">Nenhum contato cadastrado.</p>
            </div>
        </div>

        <!-- AGENDAMENTOS -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-clock"></i> Agendamentos</span>
                <button class="btn btn-primary" onclick="mostrarFormAgendamento()" style="font-size:11px; padding:4px 10px;">
                    <i class="fas fa-plus"></i> Novo
                </button>
            </div>
            <!-- Formulario -->
            <div id="formAgendamento" style="display:none; margin-bottom:15px; padding:12px; background:rgba(255,255,255,0.02); border-radius:8px; border:1px solid var(--border);">
                <div class="form-row" style="flex-wrap:wrap; gap:8px;">
                    <div class="form-group" style="flex:1; min-width:150px;">
                        <label class="form-label">Nome</label>
                        <input class="form-input" id="agendNome" placeholder="Processamento Matutino" style="font-size:12px;">
                    </div>
                    <div class="form-group" style="flex:0.5; min-width:80px;">
                        <label class="form-label">Horario</label>
                        <input class="form-input" id="agendHora" type="time" value="08:00" style="font-size:12px;">
                    </div>
                    <div class="form-group" style="flex:1.5; min-width:200px;">
                        <label class="form-label">Dias da Semana</label>
                        <div style="display:flex; gap:4px; flex-wrap:wrap; font-size:11px;">
                            <label><input type="checkbox" class="agendDia" value="seg" checked> Seg</label>
                            <label><input type="checkbox" class="agendDia" value="ter" checked> Ter</label>
                            <label><input type="checkbox" class="agendDia" value="qua" checked> Qua</label>
                            <label><input type="checkbox" class="agendDia" value="qui" checked> Qui</label>
                            <label><input type="checkbox" class="agendDia" value="sex" checked> Sex</label>
                            <label><input type="checkbox" class="agendDia" value="sab"> Sab</label>
                            <label><input type="checkbox" class="agendDia" value="dom"> Dom</label>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:12px; margin-top:10px; font-size:11px; color:var(--text-secondary);">
                    <label><input type="checkbox" id="agendUpseller" checked> Baixar UpSeller</label>
                    <label><input type="checkbox" id="agendProcessar" checked> Processar Etiquetas</label>
                    <label><input type="checkbox" id="agendWhatsapp" checked> Enviar WhatsApp</label>
                </div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn btn-primary" onclick="salvarAgendamento()" style="font-size:11px;">
                        <i class="fas fa-check"></i> Salvar
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('formAgendamento').style.display='none'" style="font-size:11px;">
                        Cancelar
                    </button>
                </div>
            </div>
            <!-- Tabela -->
            <div id="tabelaAgendamentos" style="overflow-x:auto;">
                <p style="font-size:12px; color:var(--text-secondary);">Nenhum agendamento configurado.</p>
            </div>
        </div>

        <!-- EXECUCAO MANUAL -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-play-circle"></i> Execucao Manual</span>
            </div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">
                Executa o pipeline completo: baixar do UpSeller  processar etiquetas  enviar via WhatsApp.
            </p>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn btn-primary" onclick="executarPipelineAgora()" style="font-size:12px;">
                    <i class="fas fa-rocket"></i> Executar Pipeline Completo
                </button>
                <button class="btn btn-secondary" onclick="enviarWhatsAppManual()" style="font-size:12px;">
                    <i class="fab fa-whatsapp"></i> Enviar Ultimo Resultado via WhatsApp
                </button>
            </div>
        </div>

        <!-- HISTORICO -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-history"></i> Historico de Execucoes</span>
                <button class="btn btn-secondary" onclick="carregarHistorico()" style="font-size:11px; padding:4px 10px;">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="tabelaHistorico" style="overflow-x:auto;">
                <p style="font-size:12px; color:var(--text-secondary);">Nenhuma execucao registrada.</p>
            </div>
        </div>
    </div>

    <!-- ==================== ADMIN ==================== -->
    <div class="tab-content" id="tab-admin">
        <h3 class="section-title"><i class="fas fa-shield-alt"></i> Painel Administrativo</h3>

        <!-- Liberar acesso -->
        <div class="card" style="margin-bottom:20px;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-user-plus"></i> Liberar Acesso Gratuito</span>
            </div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:14px;">
                Libere acesso gratuito a qualquer email cadastrado. O usuario recebera o plano selecionado pelo periodo informado.
            </p>
            <div class="form-row" style="flex-wrap:wrap; gap:10px;">
                <div class="form-group" style="flex:2; min-width:200px;">
                    <label class="form-label">Email do usuario</label>
                    <input class="form-input" id="adminEmail" type="email" placeholder="usuario@email.com">
                </div>
                <div class="form-group" style="flex:1; min-width:120px;">
                    <label class="form-label">Plano</label>
                    <select class="form-input" id="adminPlano">
                        <option value="basico">Basico</option>
                        <option value="pro">Pro</option>
                        <option value="empresarial" selected>Empresarial</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1; min-width:100px;">
                    <label class="form-label">Meses</label>
                    <input class="form-input" id="adminMeses" type="number" min="1" max="120" value="1" style="width:80px;">
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary btn-sm" onclick="adminLiberarAcesso()">
                    <i class="fas fa-check"></i> Liberar Acesso
                </button>
                <button class="btn btn-secondary btn-sm" onclick="adminRevogarAcesso()" style="background:#dc2626; border-color:#dc2626; color:#fff;">
                    <i class="fas fa-ban"></i> Revogar (Free)
                </button>
            </div>
        </div>

        <!-- Lista de usuarios -->
        <div class="card">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-users"></i> Usuarios Cadastrados</span>
                <button class="btn btn-secondary btn-sm" onclick="adminCarregarUsuarios()" style="font-size:11px;">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
            </div>
            <div id="adminListaUsuarios" style="margin-top:12px; overflow-x:auto;"></div>
        </div>
    </div>

    <!-- ==================== SHOPEE EXPERT ==================== -->
    <div class="tab-content" id="tab-shopee-expert">
        <iframe src="http://localhost:8080" style="width:100%;height:calc(100vh - 120px);border:none;border-radius:var(--radius);background:var(--bg-card);"></iframe>
    </div>

</div>

<script>
const API = '';
let pollingInterval = null;
let logOffset = 0;
let _ultimoResultadoJSON = '';  // Cache para evitar re-render desnecessario

// ================================================================
// AUTH
// ================================================================
function getToken() {
    return localStorage.getItem('token');
}

async function sair() {
    try {
        await fetch(API + '/api/auth/logout', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
    } catch(e) {}
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/login';
}

let _planoSelecionado = '';
let _periodoSelecionado = 'mensal';
let _cupomDigitado = '';
let _planosData = [];

async function assinarPremium() {
    const res = await fetchAPI('/api/planos');
    if (!res || !res.planos) { toast('Erro ao carregar planos', 'error'); return; }
    _planosData = res.planos;
    _planoSelecionado = '';
    _periodoSelecionado = 'mensal';
    _cupomDigitado = '';

    let modal = document.getElementById('modalPlanos');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalPlanos';
        modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; overflow-y:auto; padding:20px;';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
    }
    _renderModalPlanos(modal);
}

function _renderModalPlanos(modal) {
    const planos = _planosData;
    let html = `<div style="background:var(--bg-card); border-radius:var(--radius); padding:24px; width:440px; max-width:95vw;">
    <div style="text-align:center; margin-bottom:16px;">
        <h3 style="margin-bottom:4px;">Escolha seu plano</h3>
        <span style="color:var(--text-secondary); font-size:13px;">Processamentos ilimitados em todos os planos pagos</span>
    </div>`;

    // Planos
    for (const p of planos) {
        const sel = _planoSelecionado === p.id;
        html += `<div onclick="_selecionarPlano('${p.id}')" style="cursor:pointer; padding:14px 16px; margin-bottom:8px; background:${sel ? 'rgba(139,92,246,0.15)' : 'var(--bg-input)'}; border:2px solid ${sel ? '#8b5cf6' : 'var(--border)'}; border-radius:var(--radius-sm); display:flex; justify-content:space-between; align-items:center; transition:all 0.2s;">
            <div>
                <div style="font-weight:600; font-size:15px;">${p.nome}</div>
                <div style="font-size:12px; color:var(--text-secondary);">Ate ${p.max_ips} dispositivo(s)</div>
            </div>
            <div style="font-size:18px; font-weight:700; color:var(--accent);">R$ ${p.valor.toFixed(2)}<span style="font-size:11px; color:var(--text-muted);">/mes</span></div>
        </div>`;
    }

    // Periodo (aparece apos selecionar plano)
    if (_planoSelecionado) {
        const plano = planos.find(p => p.id === _planoSelecionado);
        const vm = plano ? plano.valor : 0;
        html += `<div style="margin-top:16px; padding:14px; background:var(--bg-input); border-radius:var(--radius-sm); border:1px solid var(--border);">
            <div style="font-weight:600; font-size:13px; margin-bottom:10px;"><i class="fas fa-calendar-alt"></i> Periodo de assinatura</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">`;
        const periodos = [
            {id: 'mensal',    label: 'Mensal',    desc: '', meses: 1, desconto: 0},
            {id: 'semestral', label: 'Semestral',  desc: '-20%', meses: 6, desconto: 0.20},
            {id: 'anual',     label: 'Anual',      desc: '-30%', meses: 12, desconto: 0.30},
        ];
        for (const per of periodos) {
            const sel = _periodoSelecionado === per.id;
            const totalOrig = vm * per.meses;
            const totalDesc = Math.round(totalOrig * (1 - per.desconto) * 100) / 100;
            const mensal = per.meses > 0 ? (totalDesc / per.meses).toFixed(2) : vm.toFixed(2);
            html += `<div onclick="_selecionarPeriodo('${per.id}')" style="cursor:pointer; flex:1; min-width:110px; padding:10px 8px; text-align:center; background:${sel ? 'rgba(139,92,246,0.15)' : 'var(--bg-card)'}; border:2px solid ${sel ? '#8b5cf6' : 'var(--border)'}; border-radius:8px; transition:all 0.2s;">
                <div style="font-weight:600; font-size:13px;">${per.label}</div>
                ${per.desc ? `<div style="font-size:11px; color:#22c55e; font-weight:600;">${per.desc}</div>` : ''}
                <div style="font-size:15px; font-weight:700; color:var(--accent); margin-top:4px;">R$ ${totalDesc.toFixed(2)}</div>
                ${per.meses > 1 ? `<div style="font-size:10px; color:var(--text-muted);">R$ ${mensal}/mes</div>` : ''}
            </div>`;
        }
        html += `</div></div>`;

        // Campo de cupom
        html += `<div style="margin-top:12px; padding:12px 14px; background:var(--bg-input); border-radius:var(--radius-sm); border:1px solid var(--border);">
            <div style="font-weight:600; font-size:13px; margin-bottom:8px;"><i class="fas fa-gift"></i> Cupom de indicacao <span style="font-size:11px; font-weight:400; color:var(--text-muted);">(opcional)</span></div>
            <div style="display:flex; gap:8px; align-items:center;">
                <input class="form-input" id="inputCupomPlano" type="text" placeholder="Digite o cupom" value="${_cupomDigitado}" style="flex:1; font-size:13px; text-transform:uppercase;" oninput="_cupomDigitado=this.value.toUpperCase()">
                <button class="btn btn-secondary btn-sm" onclick="_validarCupomPlano()" style="font-size:11px; white-space:nowrap;">Validar</button>
            </div>
            <div id="cupomFeedback" style="font-size:11px; margin-top:6px;"></div>
        </div>`;

        // Botao contratar
        const selPer = periodos.find(p => p.id === _periodoSelecionado);
        const totalFinal = Math.round(vm * selPer.meses * (1 - selPer.desconto) * 100) / 100;
        html += `<button onclick="contratarPlano()" class="btn" style="width:100%; margin-top:16px; background:linear-gradient(135deg,#8b5cf6,#6d28d9); color:#fff; font-size:15px; padding:14px;">
            <i class="fas fa-credit-card"></i> Pagar R$ ${totalFinal.toFixed(2)}
        </button>`;
    }

    html += `<div style="text-align:center; margin-top:12px;">
        <button onclick="document.getElementById('modalPlanos').remove()" class="btn btn-secondary btn-sm">Cancelar</button>
        <button onclick="_abrirIndicacao()" class="btn btn-secondary btn-sm" style="margin-left:6px;"><i class="fas fa-share-alt"></i> Meu cupom</button>
    </div></div>`;

    modal.innerHTML = html;
}

function _selecionarPlano(id) {
    _planoSelecionado = id;
    const modal = document.getElementById('modalPlanos');
    if (modal) _renderModalPlanos(modal);
}

function _selecionarPeriodo(id) {
    _periodoSelecionado = id;
    const modal = document.getElementById('modalPlanos');
    if (modal) _renderModalPlanos(modal);
}

async function _validarCupomPlano() {
    const cupom = (document.getElementById('inputCupomPlano')?.value || '').trim().toUpperCase();
    _cupomDigitado = cupom;
    const fb = document.getElementById('cupomFeedback');
    if (!cupom) { fb.innerHTML = ''; return; }

    const res = await fetchAPI('/api/indicacao/validar-cupom', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cupom }),
    });
    if (res && res.valido) {
        fb.innerHTML = `<span style="color:#22c55e;"><i class="fas fa-check-circle"></i> ${res.mensagem}</span>`;
    } else {
        fb.innerHTML = `<span style="color:#ef4444;"><i class="fas fa-times-circle"></i> ${res?.erro || 'Cupom invalido'}</span>`;
    }
}

async function contratarPlano() {
    if (!_planoSelecionado) { toast('Selecione um plano', 'warning'); return; }
    const modal = document.getElementById('modalPlanos');
    if (modal) modal.remove();

    toast('Redirecionando para pagamento...', 'info');
    const body = { plano: _planoSelecionado, periodo: _periodoSelecionado };
    if (_cupomDigitado) body.cupom = _cupomDigitado;

    const res = await fetchAPI('/api/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
    });
    if (res && res.url) {
        window.open(res.url, '_blank');
    } else {
        toast(res?.erro || 'Erro ao criar pagamento', 'error');
    }
}

async function _abrirIndicacao() {
    const res = await fetchAPI('/api/indicacao/meu-cupom');
    if (!res) { toast('Erro ao carregar cupom', 'error'); return; }

    let modal = document.getElementById('modalIndicacao');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalIndicacao';
        modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:10000; padding:20px;';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div style="background:var(--bg-card); border-radius:var(--radius); padding:28px; width:380px; max-width:95vw; text-align:center;">
        <h3 style="margin-bottom:4px;"><i class="fas fa-gift"></i> Indique e Ganhe</h3>
        <p style="color:var(--text-secondary); font-size:13px; margin-bottom:20px;">Compartilhe seu cupom e ganhe 1 mes gratis por cada indicacao!</p>

        <div style="background:var(--bg-input); border:2px dashed var(--accent); border-radius:12px; padding:16px; margin-bottom:16px;">
            <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Seu cupom:</div>
            <div style="font-size:28px; font-weight:700; color:var(--accent); letter-spacing:3px;">${res.cupom}</div>
        </div>

        <button class="btn btn-primary btn-sm" onclick="navigator.clipboard.writeText('${res.cupom}'); toast('Cupom copiado!', 'success');" style="margin-bottom:16px;">
            <i class="fas fa-copy"></i> Copiar Cupom
        </button>

        <div style="display:flex; gap:16px; justify-content:center; margin-bottom:16px;">
            <div style="text-align:center;">
                <div style="font-size:24px; font-weight:700; color:#22c55e;">${res.total_indicados}</div>
                <div style="font-size:11px; color:var(--text-muted);">Indicados</div>
            </div>
            <div style="text-align:center;">
                <div style="font-size:24px; font-weight:700; color:var(--accent);">${res.meses_gratis}</div>
                <div style="font-size:11px; color:var(--text-muted);">Meses gratis</div>
            </div>
        </div>

        <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">
            <i class="fas fa-info-circle"></i> Voce ganha 1 mes gratis a cada amigo que assinar usando seu cupom. Seu amigo tambem ganha 1 mes gratis!
        </div>

        <button onclick="document.getElementById('modalIndicacao').remove()" class="btn btn-secondary btn-sm">Fechar</button>
    </div>`;
}

function atualizarInfoUsuario(user) {
    if (!user) return;
    const badge = document.getElementById('planoBadge');
    const btnAssinar = document.getElementById('btnAssinar');
    badge.style.display = 'inline-block';

    if (user.plano !== 'free') {
        let txt = `${user.plano_nome} (${user.dispositivos}/${user.max_dispositivos} IPs)`;
        if (user.plano_expira) txt += ` ate ${user.plano_expira}`;
        badge.textContent = txt;
        badge.style.background = '#1b2d1b';
        badge.style.color = '#22c55e';
        btnAssinar.innerHTML = '<i class="fas fa-crown"></i> Upgrade';
        btnAssinar.style.display = 'inline-flex';
    } else {
        const limite = user.limite_mes > 0 ? `${user.processamentos_mes}/${user.limite_mes}` : '';
        badge.textContent = `Free ${limite}`;
        badge.style.background = '#2d1b4e';
        badge.style.color = '#a78bfa';
        btnAssinar.innerHTML = '<i class="fas fa-crown"></i> Assinar';
        btnAssinar.style.display = 'inline-flex';
    }
}

// ================================================================
// TABS
// ================================================================
let configCarregada = false;

function trocarTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const navEl = document.querySelector(`[data-tab="${tab}"]`);
    const tabEl = document.getElementById(`tab-${tab}`);
    if (navEl) navEl.classList.add('active');
    if (tabEl) tabEl.classList.add('active');
    // Carregar lojas do Lucro independentemente (via XMLs da pasta_lucro)
    if (tab === 'lucro') carregarLojasLucro();
    if (tab === 'automacao') carregarDadosAutomacao();
    if (tab === 'admin') adminCarregarUsuarios();
}

async function carregarLojasLucro() {
    const data = await fetchAPI('/api/lojas-lucro');
    if (data && data.lojas && data.lojas.length > 0) {
        renderConfigLucroLojas(data.lojas);
    }
}

async function atualizarLojasLucro() {
    const btn = document.getElementById('btnAtualizarLojasLucro');
    const iconEl = btn.querySelector('i');
    btn.disabled = true;
    iconEl.classList.add('fa-spin');
    try {
        await carregarLojasLucro();
        toast('Lojas atualizadas!', 'success');
    } catch(e) {
        toast('Erro ao atualizar lojas: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        iconEl.classList.remove('fa-spin');
    }
}

// ================================================================
// API CALLS
// ================================================================
async function fetchAPI(url, options = {}) {
    try {
        const token = getToken();
        if (!options.headers) options.headers = {};
        if (token) options.headers['Authorization'] = 'Bearer ' + token;

        const res = await fetch(API + url, options);

        // Se nao autorizado, redireciona pro login
        if (res.status === 401 || res.status === 422) {
            sair();
            return null;
        }

        return await res.json();
    } catch (e) {
        console.error('API Error:', e);
        return null;
    }
}

async function baixarArquivo(url, nomeArquivo) {
    try {
        const token = getToken();
        const res = await fetch(API + url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 401 || res.status === 422) { sair(); return; }
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(err.erro || 'Erro ao baixar arquivo');
            return;
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = nomeArquivo || 'download';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 100);
    } catch (e) {
        console.error('Download error:', e);
        alert('Erro ao baixar arquivo');
    }
}

// ================================================================
// ATUALIZAR DASHBOARD
// ================================================================
async function atualizarStatus() {
    const data = await fetchAPI('/api/status');
    if (!data) return;

    // Atualizar info do usuario
    if (data.user) {
        atualizarInfoUsuario(data.user);
        verificarAdmin();
    }

    // Status
    const dot = document.getElementById('statusDot');
    const txt = document.getElementById('statusText');
    const bar = document.getElementById('progressBar');
    const btn = document.getElementById('btnProcessar');

    // Stats
    const pdfs = data.arquivos_entrada.filter(a => a.tipo === 'PDF').length;
    const xlsxs = data.arquivos_entrada.filter(a => a.tipo === 'XLSX').length;
    document.getElementById('statPdfs').textContent = pdfs;
    document.getElementById('statZips').textContent = xlsxs;

    // Aviso de upload
    const avisoEl = document.getElementById('avisoUpload');
    if (data.processando) {
        dot.classList.add('processing');
        txt.textContent = 'Processando...';
        bar.classList.add('active');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Processando...';
        avisoEl.style.display = 'none';
    } else {
        dot.classList.remove('processing');
        txt.textContent = 'Pronto';
        bar.classList.remove('active');
        if (!uploadEmAndamento) {
            if (pdfs === 0) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Processamento';
                avisoEl.style.display = 'block';
                avisoEl.style.background = 'rgba(255,80,80,0.15)';
                avisoEl.style.color = '#ff6b6b';
                avisoEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Envie pelo menos 1 arquivo PDF para processar.';
            } else if (xlsxs === 0) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Processamento';
                avisoEl.style.display = 'block';
                avisoEl.style.background = 'rgba(255,193,7,0.15)';
                avisoEl.style.color = '#ffc107';
                avisoEl.innerHTML = '<i class="fas fa-info-circle"></i> Nenhum XLSX enviado. Os dados de produto (SKU, variacao) nao serao exibidos nas etiquetas.';
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Processamento';
                avisoEl.style.display = 'none';
            }
        }
    }

    if (data.ultimo_resultado) {
        document.getElementById('statEtiquetas').textContent = data.ultimo_resultado.total_etiquetas;
        document.getElementById('statLojas').textContent = data.ultimo_resultado.total_lojas;

        // So re-renderiza resultados se os dados mudaram (evita perder checkboxes marcados)
        const resultadoJSON = JSON.stringify(data.ultimo_resultado);
        if (resultadoJSON !== _ultimoResultadoJSON) {
            _ultimoResultadoJSON = resultadoJSON;

            // Salvar estado dos checkboxes antes de re-renderizar
            const checkedLojas = new Set();
            document.querySelectorAll('.loja-check:checked').forEach(c => checkedLojas.add(c.dataset.cnpj));
            const checkedGrupoLojas = new Set();
            document.querySelectorAll('.grupo-loja-check:checked').forEach(c => checkedGrupoLojas.add(c.dataset.cnpj));

            renderUltimoResultado(data.ultimo_resultado);
            renderResultadosLojas(data.ultimo_resultado);
            renderResumoGeral(data.ultimo_resultado);

            // Restaurar checkboxes apos re-render
            if (checkedLojas.size > 0) {
                document.querySelectorAll('.loja-check').forEach(c => {
                    if (checkedLojas.has(c.dataset.cnpj)) c.checked = true;
                });
                atualizarBarraAgrupar();
            }

            // Lojas disponiveis para agrupamento
            if (data.ultimo_resultado.lojas) {
                renderLojasParaGrupo(data.ultimo_resultado.lojas);

                // Restaurar checkboxes de grupo
                if (checkedGrupoLojas.size > 0) {
                    document.querySelectorAll('.grupo-loja-check').forEach(c => {
                        if (checkedGrupoLojas.has(c.dataset.cnpj)) c.checked = true;
                    });
                }
            }
        }
    } else {
        document.getElementById('statEtiquetas').textContent = '-';
        document.getElementById('statLojas').textContent = '-';
    }

    // Arquivos
    renderArquivos(data.arquivos_entrada);
    renderArquivosLucro(data.arquivos_lucro);

    // Config  so carrega uma vez para nao sobrescrever edicoes do usuario
    if (!configCarregada) {
        const cfg = data.configuracoes;
        document.getElementById('cfgLargura').value = cfg.largura_mm;
        document.getElementById('cfgAltura').value = cfg.altura_mm;
        document.getElementById('cfgMargemEsq').value = cfg.margem_esq;
        document.getElementById('cfgMargemDir').value = cfg.margem_dir;
        document.getElementById('cfgMargemTopo').value = cfg.margem_topo;
        document.getElementById('cfgMargemInf').value = cfg.margem_inf;
        document.getElementById('cfgFonteProduto').value = cfg.fonte_produto || 7;
        document.getElementById('cfgExibicaoProduto').value = cfg.exibicao_produto || 'sku';
        document.getElementById('cfgPercDeclarado').value = cfg.perc_declarado || 100;
        document.getElementById('cfgTaxaShopee').value = cfg.taxa_shopee || 18;
        document.getElementById('cfgImpostoSimples').value = cfg.imposto_simples || 4;
        document.getElementById('cfgCustoFixo').value = cfg.custo_fixo || 3;
        if (cfg.planilha_custos) {
            document.getElementById('lblPlanilhaCustos').textContent = cfg.planilha_custos.split(/[/\\]/).pop();
        }
        configCarregada = true;
    }

    // Agrupamentos
    if (data.agrupamentos) {
        renderGruposSalvos(data.agrupamentos);
    }

    // Lucro
    if (data.ultimo_lucro) {
        renderResumoLucro(data.ultimo_lucro);
    }
}

function renderUltimoResultado(res) {
    if (!res) return;
    const el = document.getElementById('ultimoResultado');
    const lojasHtml = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:4px;">' +
        res.lojas.map(l => `
            <div class="stat-mini">
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:700; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${l.nome}</div>
                    <div style="font-size:10px; color:var(--text-secondary);">${l.etiquetas} etiq | ${l.skus} SKU | ${l.total_qtd} un</div>
                </div>
                <span class="badge badge-success" style="font-size:10px; padding:2px 6px;">${l.paginas}p</span>
            </div>
        `).join('') + '</div>';

    const avisoSemNf = (res.etiquetas_sem_nf && res.etiquetas_sem_nf > 0)
        ? `<div style="margin-bottom:6px; padding:6px 10px; background:#cc0000; border-radius:var(--radius-xs); font-size:11px; color:#fff;">
                <i class="fas fa-exclamation-circle"></i> ${res.etiquetas_sem_nf} etiqueta(s) sem NF/Declaracao
           </div>`
        : '';

    el.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:11px; color:var(--text-muted);">
            <span>${res.timestamp} <span class="badge badge-success" style="font-size:10px;">${res.duracao_s}s</span></span>
            <span><strong>${res.total_etiquetas}</strong> etiq | <strong>${res.total_lojas}</strong> lojas</span>
        </div>
        ${avisoSemNf}
        ${lojasHtml}
    `;
}

function renderResultadosLojas(res) {
    if (!res || !res.lojas.length) return;
    const el = document.getElementById('resultadosLojas');
    const colors = ['#f05d23', '#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

    let html = `
    <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:center;">
        <button class="btn btn-primary" onclick="baixarArquivo('/api/download-todos', 'Etiquetas_prontas.zip')" style="padding:10px 20px; font-size:13px; font-weight:600;">
            <i class="fas fa-download" style="margin-right:6px;"></i> Baixar ZIP
        </button>
        <span style="font-size:12px; color:var(--text-muted);">O download automatico ja foi iniciado ao concluir o processamento</span>
    </div>`;

    html += '<div class="resultado-grid">' + res.lojas.map((l, i) => {
        const initial = l.nome.charAt(0).toUpperCase();
        const color = colors[i % colors.length];
        return `
        <div class="loja-card">
            <div class="loja-header">
                <div class="loja-avatar" style="background:linear-gradient(135deg, ${color}, ${color}88)">${initial}</div>
                <div style="flex:1">
                    <div class="loja-name">${l.nome}</div>
                    <div class="loja-cnpj">${formatCNPJ(l.cnpj)}</div>
                </div>
                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:11px; color:var(--text-secondary); padding:4px 8px; border:1px solid var(--border); border-radius:var(--radius-xs); background:var(--bg-input);">
                    <input type="checkbox" class="loja-check" data-cnpj="${l.cnpj}" data-nome="${l.nome}" onchange="atualizarBarraAgrupar()">
                    <i class="fas fa-layer-group"></i>
                </label>
            </div>
            <div class="loja-stats">
                <div class="loja-stat">
                    <div class="loja-stat-value">${l.etiquetas}</div>
                    <div class="loja-stat-label">Etiquetas</div>
                </div>
                <div class="loja-stat">
                    <div class="loja-stat-value">${l.skus}</div>
                    <div class="loja-stat-label">SKUs</div>
                </div>
                <div class="loja-stat">
                    <div class="loja-stat-value">${l.total_qtd}</div>
                    <div class="loja-stat-label">Unidades</div>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">
                <span>${l.simples} simples</span> &bull;
                <span>${l.multi_produto} multi-produto</span>
                ${l.sem_xml > 0 ? ` &bull; <span style="color:var(--warning)">${l.sem_xml} sem XML</span>` : ''}
            </div>
            <div class="loja-actions">
                <button class="btn btn-secondary btn-sm" onclick="baixarArquivo('/api/download/${encodeURIComponent(l.nome)}/${encodeURIComponent(l.pdf)}', '${l.pdf}')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-secondary btn-sm" onclick="baixarArquivo('/api/download/${encodeURIComponent(l.nome)}/${encodeURIComponent(l.xlsx)}', '${l.xlsx}')">
                    <i class="fas fa-file-excel"></i> XLSX
                </button>
            </div>
        </div>`;
    }).join('') + '</div>';

    el.innerHTML = html;
}

function renderArquivos(arquivos) {
    const el = document.getElementById('listaArquivos');
    if (!el) return;
    if (!arquivos.length) {
        el.innerHTML = `<div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>Pasta vazia</h3>
            <p>Adicione arquivos PDF e ZIP para processar</p>
        </div>`;
        return;
    }
    el.innerHTML = arquivos.map(a => `
        <div class="file-item">
            <div class="file-info">
                <div class="file-icon ${a.tipo.toLowerCase()}">
                    <i class="fas fa-file-${a.tipo === 'PDF' ? 'pdf' : 'archive'}"></i>
                </div>
                <div>
                    <div class="file-name">${a.nome}</div>
                    <div class="file-size">${a.tamanho_fmt}</div>
                </div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
                <span class="badge ${a.tipo === 'PDF' ? 'badge-pdf' : 'badge-zip'}">${a.tipo}</span>
                <button class="btn btn-danger btn-sm" onclick="removerArquivo('${a.nome}')" data-tooltip="Remover">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// ================================================================
// LOGS
// ================================================================
async function atualizarLogs() {
    const data = await fetchAPI(`/api/logs?desde=${logOffset}`);
    if (!data || !data.logs.length) return;

    const panel = document.getElementById('logContainer');
    if (!panel) return;
    if (logOffset === 0 && data.logs.length > 0) {
        panel.innerHTML = '';
    }

    data.logs.forEach(log => {
        const div = document.createElement('div');
        div.style.cssText = 'padding:2px 0; border-bottom:1px solid rgba(255,255,255,0.03);';
        const cor = log.tipo === 'erro' ? 'var(--error)' : log.tipo === 'aviso' ? 'var(--warning)' : 'var(--text-secondary)';
        div.innerHTML = `<span style="color:var(--text-muted); margin-right:8px;">${log.timestamp}</span><span style="color:${cor};">${escapeHtml(log.mensagem)}</span>`;
        panel.appendChild(div);
    });

    logOffset = data.total;
    panel.scrollTop = panel.scrollHeight;
}

function limparLogs() {
    const el = document.getElementById('logContainer');
    if (el) el.innerHTML = '<div style="color:var(--text-muted);">Aguardando...</div>';
    logOffset = 0;
}

// ================================================================
// ACOES
// ================================================================
async function processar() {
    // Verificar se ha grupo incompleto (lojas marcadas sem salvar)
    if (verificarGrupoIncompleto()) {
        toast('Grupo nao salvo! Adicione o grupo com o botao + ou desmarque as lojas antes de processar.', 'warning');
        trocarTab('painel');
        return;
    }
    const data = await fetchAPI('/api/processar', { method: 'POST' });
    if (data && data.erro) {
        toast(data.erro, 'warning');
        return;
    }
    toast('Processamento iniciado!', 'info');
    logOffset = 0;
    trocarTab('painel');

    // Polling mais rapido durante processamento
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = setInterval(async () => {
        await atualizarStatus();
        await atualizarLogs();

        const dot = document.getElementById('statusDot');
        if (!dot.classList.contains('processing')) {
            clearInterval(pollingInterval);
            pollingInterval = setInterval(() => { atualizarStatus(); atualizarLogs(); }, 5000);
            toast('Processamento concluido! Baixando resultados...', 'success');
            // Download automatico do ZIP
            baixarArquivo('/api/download-todos', 'Etiquetas_prontas.zip');
            trocarTab('painel');
        }
    }, 800);
}

async function salvarConfig() {
    const cfg = {
        largura_mm: parseInt(document.getElementById('cfgLargura').value),
        altura_mm: parseInt(document.getElementById('cfgAltura').value),
        margem_esq: parseInt(document.getElementById('cfgMargemEsq').value),
        margem_dir: parseInt(document.getElementById('cfgMargemDir').value),
        margem_topo: parseInt(document.getElementById('cfgMargemTopo').value),
        margem_inf: parseInt(document.getElementById('cfgMargemInf').value),
        fonte_produto: parseInt(document.getElementById('cfgFonteProduto').value) || 7,
        exibicao_produto: document.getElementById('cfgExibicaoProduto').value || 'sku',
        perc_declarado: parseFloat(document.getElementById('cfgPercDeclarado').value) || 100,
        taxa_shopee: parseFloat(document.getElementById('cfgTaxaShopee').value) || 18,
        imposto_simples: parseFloat(document.getElementById('cfgImpostoSimples').value) || 4,
        custo_fixo: parseFloat(document.getElementById('cfgCustoFixo').value) || 3,
    };
    await fetchAPI('/api/configuracoes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cfg),
    });
    toast('Configuracoes salvas!', 'success');
}

async function limparSaida() {
    if (!confirm('Tem certeza que deseja limpar toda a pasta de saida?')) return;
    await fetchAPI('/api/limpar-saida', { method: 'POST' });
    toast('Pasta de saida limpa', 'warning');
    atualizarStatus();
}

async function novoLote() {
    if (!confirm('Isso vai limpar os arquivos de ETIQUETAS (entrada e saida). Os arquivos da aba Lucro serao mantidos. Continuar?')) return;
    const data = await fetchAPI('/api/novo-lote', { method: 'POST' });
    if (data && data.ok) {
        toast('Pronto para novo lote! Adicione os novos arquivos.', 'success');
        _ultimoResultadoJSON = '';
        document.getElementById('ultimoResultado').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Nenhum processamento realizado</h3>
                <p>Clique em "Iniciar Processamento" para comecar</p>
            </div>`;
        document.getElementById('resultadosLojas').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>Nenhum resultado ainda</h3>
                <p>Processe as etiquetas para ver os resultados aqui</p>
            </div>`;
        document.getElementById('resumoGeral').innerHTML = '';
        const logC = document.getElementById('logContainer');
        if (logC) logC.innerHTML = '<div style="color:var(--text-muted);">Aguardando...</div>';
        logOffset = 0;
        atualizarStatus();
    } else if (data && data.erro) {
        toast(data.erro, 'warning');
    }
}

async function removerArquivo(nome) {
    if (!confirm(`Remover ${nome}?`)) return;
    await fetchAPI('/api/remover-arquivo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome }),
    });
    toast(`${nome} removido`, 'warning');
    atualizarStatus();
}

async function abrirPasta(tipo) {
    const status = await fetchAPI('/api/status');
    if (!status) return;
    const pasta = tipo === 'entrada' ? status.configuracoes.pasta_entrada : status.configuracoes.pasta_saida;
    await fetchAPI('/api/abrir-pasta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pasta }),
    });
}

async function abrirPastaLoja(nomeLoja) {
    const status = await fetchAPI('/api/status');
    if (!status) return;
    const pasta = status.configuracoes.pasta_saida + '\\' + nomeLoja;
    await fetchAPI('/api/abrir-pasta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pasta }),
    });
}

// ================================================================
// UPLOAD
// ================================================================
function handleDrop(event) {
    event.preventDefault();
    document.getElementById('uploadZone').classList.remove('dragover');
    handleUpload(event.dataTransfer.files);
}

let uploadEmAndamento = false;

async function handleUpload(files) {
    const btn = document.getElementById('btnProcessar');
    uploadEmAndamento = true;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Enviando arquivos...';

    try {
        for (const file of files) {
            const formData = new FormData();
            formData.append('arquivo', file);
            const res = await fetchAPI('/api/upload', { method: 'POST', body: formData });
            if (res && res.mensagem) {
                toast(res.mensagem, 'success');
            } else if (res && res.erro) {
                toast(res.erro, 'error');
            }
        }
    } finally {
        uploadEmAndamento = false;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Iniciar Processamento';
        atualizarStatus();
        document.getElementById('fileInput').value = '';
    }
}

// ================================================================
// UPLOAD LUCRO (aba separada)
// ================================================================
function handleDropLucro(event) {
    event.preventDefault();
    event.target.closest('.upload-zone').classList.remove('dragover');
    handleUploadLucro(event.dataTransfer.files);
}

async function handleUploadLucro(files) {
    for (const file of files) {
        const formData = new FormData();
        formData.append('arquivo', file);
        const res = await fetchAPI('/api/upload-lucro', { method: 'POST', body: formData });
        if (res && res.mensagem) {
            toast(res.mensagem, 'success');
        } else if (res && res.erro) {
            toast(res.erro, 'error');
        }
    }
    atualizarStatus();
    document.getElementById('fileInputLucro').value = '';
}

async function removerArquivoLucro(nome) {
    if (!confirm(`Remover ${nome}?`)) return;
    await fetchAPI('/api/remover-arquivo-lucro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome }),
    });
    toast(`${nome} removido`, 'warning');
    atualizarStatus();
}

function renderArquivosLucro(arquivos) {
    const el = document.getElementById('listaArquivosLucro');
    const btnLimpar = document.getElementById('btnLimparLucro');
    if (!el) return;
    if (!arquivos || arquivos.length === 0) {
        el.innerHTML = '<p style="color:var(--text-muted); font-size:12px;">Nenhum arquivo de lucro carregado</p>';
        if (btnLimpar) btnLimpar.style.display = 'none';
        return;
    }
    if (btnLimpar) btnLimpar.style.display = '';

    // Contar por tipo
    const zips = arquivos.filter(a => a.tipo === 'ZIP');
    const xmls = arquivos.filter(a => a.tipo === 'XML');
    const custos = arquivos.filter(a => a.tipo === 'CUSTOS');
    const outros = arquivos.filter(a => !['ZIP','XML','CUSTOS'].includes(a.tipo));
    const tamanhoTotal = arquivos.reduce((s, a) => s + (a.tamanho || 0), 0);
    const tamanhoFmt = tamanhoTotal > 1048576 ? (tamanhoTotal/1048576).toFixed(1) + ' MB' : (tamanhoTotal/1024).toFixed(0) + ' KB';

    // Resumo compacto
    const partes = [];
    if (zips.length > 0) partes.push(`<i class="fas fa-file-archive" style="color:var(--primary);"></i> ${zips.length} ZIP`);
    if (xmls.length > 0) partes.push(`<i class="fas fa-file-code" style="color:var(--primary);"></i> ${xmls.length} XML`);
    if (custos.length > 0) partes.push(`<i class="fas fa-file-excel" style="color:var(--success);"></i> Custos`);
    if (outros.length > 0) partes.push(`${outros.length} outro(s)`);

    el.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; background:var(--bg-dark); border-radius:6px;">
            <span style="font-size:12px; display:flex; align-items:center; gap:12px;">
                <strong>${arquivos.length}</strong> arquivo(s) &middot; ${partes.join(' &middot; ')} &middot; <span style="color:var(--text-muted);">${tamanhoFmt}</span>
            </span>
            <button onclick="toggleListaLucro()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:12px;" title="Ver detalhes">
                <i class="fas fa-chevron-down" id="iconListaLucro"></i>
            </button>
        </div>
        <div id="detalhesArquivosLucro" style="display:none; max-height:200px; overflow-y:auto; margin-top:4px;">
            ${arquivos.map(a => `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:4px 10px; background:var(--bg-dark); border-radius:4px; margin-bottom:2px; font-size:12px;">
                    <span>
                        <i class="fas ${a.tipo === 'ZIP' ? 'fa-file-archive' : a.tipo === 'CUSTOS' ? 'fa-file-excel' : 'fa-file-code'}" style="color:var(--primary); margin-right:6px;"></i>
                        ${a.nome} <span style="color:var(--text-muted); font-size:10px;">(${a.tamanho_fmt})</span>
                    </span>
                    <button onclick="removerArquivoLucro('${a.nome}')" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:12px;" title="Remover">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('')}
        </div>
    `;
}

function toggleListaLucro() {
    const det = document.getElementById('detalhesArquivosLucro');
    const icon = document.getElementById('iconListaLucro');
    if (!det) return;
    const aberto = det.style.display !== 'none';
    det.style.display = aberto ? 'none' : 'block';
    if (icon) icon.className = aberto ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
}

async function limparUploadsLucro() {
    if (!confirm('Remover todos os arquivos de lucro (ZIPs, XMLs e planilha de custos)?')) return;
    const res = await fetchAPI('/api/limpar-lucro', { method: 'POST' });
    if (res && res.ok) {
        toast('Arquivos de lucro removidos', 'success');
        const el = document.getElementById('resumoLucro');
        if (el) el.innerHTML = '';
        atualizarStatus();
    } else {
        toast(res?.erro || 'Erro ao limpar', 'error');
    }
}

// ================================================================
// UTILS
// ================================================================
function formatCNPJ(cnpj) {
    if (!cnpj || cnpj.length !== 14) return cnpj;
    return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toast(msg, tipo = 'info') {
    const container = document.getElementById('toastContainer');
    const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
    const div = document.createElement('div');
    div.className = `toast ${tipo}`;
    div.innerHTML = `<i class="fas fa-${icons[tipo]}"></i> ${escapeHtml(msg)}`;
    container.appendChild(div);
    setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300); }, 4000);
}

// ================================================================
// RESUMO GERAL
// ================================================================
function renderResumoGeral(res) {
    const el = document.getElementById('resumoGeral');
    if (!res || !res.lojas || !res.lojas.length) {
        el.innerHTML = '';
        return;
    }

    const lojas = res.lojas;
    let totalEtiq = 0, totalSkus = 0, totalUn = 0;
    lojas.forEach(l => { totalEtiq += l.etiquetas; totalSkus += l.skus; totalUn += l.total_qtd; });

    const rows = lojas.map(l => `
        <tr>
            <td style="padding:8px 14px; border-bottom:1px solid var(--border); font-weight:500;">${escapeHtml(l.nome)}</td>
            <td style="padding:8px 14px; border-bottom:1px solid var(--border); text-align:center;">${l.etiquetas}</td>
            <td style="padding:8px 14px; border-bottom:1px solid var(--border); text-align:center;">${l.skus}</td>
            <td style="padding:8px 14px; border-bottom:1px solid var(--border); text-align:center; font-weight:700; color:var(--accent);">${l.total_qtd}</td>
        </tr>
    `).join('');

    el.innerHTML = `
        <div class="card">
            <div class="card-header" style="margin-bottom:12px;">
                <span class="card-title"><i class="fas fa-chart-pie"></i> Resumo Geral</span>
                <button class="btn btn-secondary btn-sm" onclick="baixarArquivo('/api/download-resumo-geral', 'resumo_geral.xlsx')">
                    <i class="fas fa-file-excel"></i> Baixar XLSX
                </button>
            </div>
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                    <tr style="background:var(--bg-input);">
                        <th style="padding:10px 14px; text-align:left; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Loja</th>
                        <th style="padding:10px 14px; text-align:center; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Etiquetas</th>
                        <th style="padding:10px 14px; text-align:center; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">SKUs</th>
                        <th style="padding:10px 14px; text-align:center; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Unidades</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
                <tfoot>
                    <tr style="background:var(--bg-input);">
                        <td style="padding:10px 14px; font-weight:800; border-top:2px solid var(--border);">TOTAL</td>
                        <td style="padding:10px 14px; text-align:center; font-weight:700; border-top:2px solid var(--border);">${totalEtiq}</td>
                        <td style="padding:10px 14px; text-align:center; font-weight:700; border-top:2px solid var(--border);">${totalSkus}</td>
                        <td style="padding:10px 14px; text-align:center; font-weight:800; border-top:2px solid var(--border); color:var(--accent); font-size:15px;">${totalUn}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
}

// ================================================================
// AGRUPAMENTO
// ================================================================
function atualizarBarraAgrupar() {
    const checked = document.querySelectorAll('.loja-check:checked');
    const bar = document.getElementById('agruparBar');
    const info = document.getElementById('agruparInfo');
    if (checked.length >= 2) {
        bar.style.display = 'flex';
        const nomes = Array.from(checked).map(c => c.dataset.nome);
        info.textContent = `${checked.length} lojas selecionadas: ${nomes.join(', ')}`;
    } else {
        bar.style.display = 'none';
    }
}

async function gerarAgrupado() {
    const checked = document.querySelectorAll('.loja-check:checked');
    if (checked.length < 2) {
        toast('Selecione pelo menos 2 lojas para agrupar', 'warning');
        return;
    }

    const cnpjs = Array.from(checked).map(c => c.dataset.cnpj);
    const nome = document.getElementById('nomeAgrupamento').value.trim() || 'Agrupado';

    const data = await fetchAPI('/api/agrupar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cnpjs, nome }),
    });

    if (data && data.erro) {
        toast(data.erro, 'error');
        return;
    }

    if (data && data.mensagem) {
        toast(data.mensagem, 'success');
        // Desmarcar checkboxes
        checked.forEach(c => c.checked = false);
        atualizarBarraAgrupar();
        document.getElementById('nomeAgrupamento').value = '';
        atualizarStatus();
    }
}

// ================================================================
// AGRUPAMENTO CONFIG (aba Configuracoes)
// ================================================================
let agrupamentosSalvos = [];

function renderGruposSalvos(grupos) {
    agrupamentosSalvos = grupos || [];
    const el = document.getElementById('listaGrupos');
    if (!grupos || !grupos.length) {
        el.innerHTML = '<div style="font-size:12px; color:var(--text-muted); padding:12px; text-align:center;">Nenhum grupo configurado</div>';
        return;
    }
    el.innerHTML = grupos.map((g, i) => `
        <div style="display:flex; align-items:center; gap:12px; padding:10px 14px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:8px;">
            <i class="fas fa-layer-group" style="color:var(--info);"></i>
            <div style="flex:1;">
                <div style="font-size:13px; font-weight:600;">${escapeHtml(g.nome)}</div>
                <div style="font-size:11px; color:var(--text-muted);">${(g.nomes_lojas || g.cnpjs || []).join(', ')}</div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="removerGrupo(${i})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function renderLojasParaGrupo(lojas) {
    const el = document.getElementById('novoGrupoLojas');
    if (!lojas || !lojas.length) {
        el.innerHTML = '<span style="font-size:11px; color:var(--text-muted);">Processe etiquetas primeiro</span>';
        return;
    }
    el.innerHTML = lojas.map(l => `
        <label style="display:flex; align-items:center; gap:4px; font-size:12px; cursor:pointer; padding:4px 8px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius-xs);">
            <input type="checkbox" class="grupo-loja-check" data-cnpj="${l.cnpj}" data-nome="${l.nome}">
            ${escapeHtml(l.nome)}
        </label>
    `).join('');
}

async function adicionarGrupo() {
    const nome = document.getElementById('novoGrupoNome').value.trim();
    if (!nome) {
        toast('Informe um nome para o grupo', 'warning');
        return;
    }
    const checked = document.querySelectorAll('.grupo-loja-check:checked');
    if (checked.length < 2) {
        toast('Selecione pelo menos 2 lojas', 'warning');
        return;
    }
    const cnpjs = Array.from(checked).map(c => c.dataset.cnpj);
    const nomes_lojas = Array.from(checked).map(c => c.dataset.nome);

    agrupamentosSalvos.push({ nome, cnpjs, nomes_lojas });

    // Salvar no backend
    await fetchAPI('/api/agrupamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agrupamentos: agrupamentosSalvos }),
    });

    toast(`Grupo "${nome}" adicionado`, 'success');
    document.getElementById('novoGrupoNome').value = '';
    checked.forEach(c => c.checked = false);
    renderGruposSalvos(agrupamentosSalvos);
    verificarGrupoIncompleto();
}

async function removerGrupo(idx) {
    agrupamentosSalvos.splice(idx, 1);
    await fetchAPI('/api/agrupamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agrupamentos: agrupamentosSalvos }),
    });
    toast('Grupo removido', 'warning');
    renderGruposSalvos(agrupamentosSalvos);
    verificarGrupoIncompleto();
}

// ================================================================
// SINCRONIZAR LOJAS (escaneia PDFs sem processar)
// ================================================================
async function sincronizarLojas() {
    const btn = document.getElementById('btnSincronizarLojas');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Escaneando...';
    try {
        const data = await fetchAPI('/api/escanear-lojas', { method: 'POST' });
        if (data && data.erro) {
            toast(data.erro, 'warning');
            return;
        }
        if (data && data.lojas && data.lojas.length > 0) {
            renderLojasParaGrupo(data.lojas);
            toast(`${data.lojas.length} loja(s) encontrada(s)`, 'success');
        } else {
            toast('Nenhuma loja encontrada. Envie PDFs e XLSX primeiro.', 'warning');
        }
    } catch (e) {
        toast('Erro ao escanear lojas', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar Lojas';
    }
}

// ================================================================
// VALIDACAO DE GRUPO INCOMPLETO
// ================================================================
function verificarGrupoIncompleto() {
    const checked = document.querySelectorAll('.grupo-loja-check:checked');
    const aviso = document.getElementById('avisoGrupoNaoSalvo');
    if (!aviso) return false;
    if (checked.length > 0) {
        aviso.style.display = 'flex';
        return true; // tem grupo incompleto
    } else {
        aviso.style.display = 'none';
        return false;
    }
}

// Observar mudancas nos checkboxes de grupo
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('grupo-loja-check')) {
        verificarGrupoIncompleto();
    }
});

// ================================================================
// LUCRO
// ================================================================
let _lucroLojasDefaults = {};
let _lucroLojasOverrides = {};

function renderConfigLucroLojas(lojas) {
    if (!lojas || !lojas.length) return;
    document.getElementById('configLucroLojas').style.display = 'block';

    // Carregar config existente
    fetchAPI('/api/configuracoes-lucro-lojas')
        .then(data => {
            if (data) {
                _lucroLojasDefaults = data.defaults || {};
                _lucroLojasOverrides = data.por_loja || {};
                _renderTabelaConfigLojas(lojas);
            }
        });
}

function _renderTabelaConfigLojas(lojas) {
    const d = _lucroLojasDefaults || {};
    const el = document.getElementById('tabelaConfigLojas');
    const rows = lojas.map(l => {
        const o = _lucroLojasOverrides[l.nome] || {};
        return `<tr>
            <td style="padding:6px 8px; font-size:12px; font-weight:600; white-space:nowrap;">${escapeHtml(l.nome)}</td>
            <td style="padding:4px; text-align:center;"><input class="form-input cfg-loja-input" data-loja="${escapeHtml(l.nome)}" data-campo="perc_declarado" type="number" step="1" value="${o.perc_declarado || ''}" placeholder="${d.perc_declarado || ''}" style="width:70px; font-size:11px; text-align:center;"></td>
            <td style="padding:4px; text-align:center;"><input class="form-input cfg-loja-input" data-loja="${escapeHtml(l.nome)}" data-campo="taxa_shopee" type="number" step="0.5" value="${o.taxa_shopee || ''}" placeholder="${d.taxa_shopee || ''}" style="width:70px; font-size:11px; text-align:center;"></td>
            <td style="padding:4px; text-align:center;"><input class="form-input cfg-loja-input" data-loja="${escapeHtml(l.nome)}" data-campo="imposto_simples" type="number" step="0.5" value="${o.imposto_simples || ''}" placeholder="${d.imposto_simples || ''}" style="width:70px; font-size:11px; text-align:center;"></td>
            <td style="padding:4px; text-align:center;"><input class="form-input cfg-loja-input" data-loja="${escapeHtml(l.nome)}" data-campo="custo_fixo" type="number" step="0.5" value="${o.custo_fixo || ''}" placeholder="${d.custo_fixo || ''}" style="width:70px; font-size:11px; text-align:center;"></td>
        </tr>`;
    }).join('');

    el.innerHTML = `
    <div style="display:flex; gap:6px; align-items:center; margin-bottom:10px; padding:8px 10px; background:var(--bg-input); border-radius:6px; flex-wrap:wrap;">
        <span style="font-size:11px; font-weight:600; white-space:nowrap;"><i class="fas fa-edit"></i> Aplicar a todas:</span>
        <input class="form-input" id="massPercDeclarado" type="number" step="1" placeholder="% Decl" style="width:65px; font-size:11px;">
        <input class="form-input" id="massTaxaShopee" type="number" step="0.5" placeholder="Shopee %" style="width:65px; font-size:11px;">
        <input class="form-input" id="massImposto" type="number" step="0.5" placeholder="Aliquota %" style="width:65px; font-size:11px;">
        <input class="form-input" id="massCustoFixo" type="number" step="0.5" placeholder="Custo R$" style="width:65px; font-size:11px;">
        <button class="btn btn-secondary btn-sm" onclick="aplicarMassaLucro()" style="font-size:11px; white-space:nowrap;">
            <i class="fas fa-copy"></i> Aplicar
        </button>
    </div>
    <table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead><tr style="background:var(--bg-input);">
            <th style="padding:8px; text-align:left;">Loja</th>
            <th style="padding:8px; text-align:center;">% Declarado</th>
            <th style="padding:8px; text-align:center;">Taxa Shopee %</th>
            <th style="padding:8px; text-align:center;">Aliquota %</th>
            <th style="padding:8px; text-align:center;">Custo Fixo R$</th>
        </tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

function aplicarMassaLucro() {
    const campos = [
        {id: 'massPercDeclarado', campo: 'perc_declarado'},
        {id: 'massTaxaShopee', campo: 'taxa_shopee'},
        {id: 'massImposto', campo: 'imposto_simples'},
        {id: 'massCustoFixo', campo: 'custo_fixo'},
    ];
    let aplicou = false;
    campos.forEach(({id, campo}) => {
        const val = document.getElementById(id).value.trim();
        if (val !== '') {
            document.querySelectorAll(`.cfg-loja-input[data-campo="${campo}"]`).forEach(inp => {
                inp.value = val;
            });
            aplicou = true;
        }
    });
    if (aplicou) {
        toast('Valores aplicados a todas as lojas', 'info');
    } else {
        toast('Preencha pelo menos um campo para aplicar', 'warning');
    }
}

async function salvarConfigLucroLojas() {
    const inputs = document.querySelectorAll('.cfg-loja-input');
    const porLoja = {};
    inputs.forEach(inp => {
        const loja = inp.dataset.loja;
        const campo = inp.dataset.campo;
        const val = inp.value.trim();
        if (val !== '') {
            if (!porLoja[loja]) porLoja[loja] = {};
            porLoja[loja][campo] = parseFloat(val);
        }
    });
    await fetchAPI('/api/configuracoes-lucro-lojas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ por_loja: porLoja }),
    });
    toast('Config lucro por loja salva!', 'success');
}

async function uploadCustos(input) {
    if (!input.files || !input.files[0]) return;
    const formData = new FormData();
    formData.append('arquivo', input.files[0]);
    const resp = await fetch('/api/upload-custos', { method: 'POST', body: formData, headers: { 'Authorization': 'Bearer ' + getToken() } });
    const data = await resp.json();
    if (data.erro) {
        toast(data.erro, 'error');
    } else {
        document.getElementById('lblPlanilhaCustos').textContent = input.files[0].name;
        toast('Planilha de custos carregada!', 'success');
    }
    input.value = '';
}

async function gerarLucro() {
    const btn = document.getElementById('btnLucro');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Gerando...';
    toast('Gerando relatorio de lucro...', 'info');

    try {
        const data = await fetchAPI('/api/gerar-lucro', { method: 'POST' });
        if (!data) {
            toast('Erro de conexao com o servidor', 'error');
        } else if (data.erro) {
            toast(data.erro, 'error');
        } else {
            toast(`Lucro gerado! Total: R$ ${data.lucro_total.toFixed(2)}`, 'success');
            renderResumoLucro(data);
            baixarArquivo('/api/download-lucro', 'Relatorio_Lucro.zip');
        }
    } catch (e) {
        toast('Erro ao gerar lucro: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-dollar-sign"></i> Resumo de Lucro';
    }
}

function renderResumoLucro(data) {
    const el = document.getElementById('resumoLucro');
    if (!data || data.lucro_total === undefined) {
        el.innerHTML = '';
        return;
    }

    const corLucro = data.lucro_total >= 0 ? 'var(--success)' : 'var(--error)';
    const alertaCusto = data.itens_sem_custo > 0
        ? `<div style="margin-top:10px; padding:8px 12px; background:#fff3cd; border:1px solid #ffc107; border-radius:var(--radius-sm); font-size:12px; color:#856404;"><i class="fas fa-exclamation-triangle"></i> ${data.itens_sem_custo} itens sem custo na planilha (destacados em amarelo no XLSX)</div>`
        : '';

    // Tabela por loja
    let tabelaLojas = '';
    if (data.lojas && data.lojas.length > 0) {
        const colors = ['#f05d23', '#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
        const rowsLojas = data.lojas.map((l, i) => {
            const corL = l.lucro >= 0 ? 'var(--success)' : 'var(--error)';
            const initial = l.nome.charAt(0).toUpperCase();
            const color = colors[i % colors.length];
            return `<tr>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:32px; height:32px; border-radius:6px; background:linear-gradient(135deg, ${color}, ${color}88); display:flex; align-items:center; justify-content:center; font-weight:800; color:white; font-size:13px;">${initial}</div>
                        <div>
                            <div style="font-weight:600; font-size:13px;">${escapeHtml(l.nome)}</div>
                            ${l.itens_sem_custo > 0 ? `<div style="font-size:10px; color:var(--warning);">${l.itens_sem_custo} sem custo</div>` : ''}
                        </div>
                    </div>
                </td>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border); text-align:center; font-size:13px;">${l.total_itens}</td>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border); text-align:right; font-size:13px; color:var(--info);">R$ ${l.receita.toFixed(2)}</td>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border); text-align:right; font-size:13px; color:var(--warning);">R$ ${l.custo.toFixed(2)}</td>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border); text-align:right; font-size:14px; font-weight:700; color:${corL};">R$ ${l.lucro.toFixed(2)}</td>
                <td style="padding:10px 14px; border-bottom:1px solid var(--border); text-align:center;">
                    <button class="btn btn-secondary btn-sm" onclick="baixarArquivo('/api/download-lucro/${encodeURIComponent(l.nome)}', 'lucro_${l.nome}.xlsx')" style="font-size:11px;">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                </td>
            </tr>`;
        }).join('');

        tabelaLojas = `
        <div style="margin-top:16px;">
            <div style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">
                <i class="fas fa-store"></i> Detalhamento por Loja
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                    <thead>
                        <tr style="background:var(--bg-input);">
                            <th style="padding:10px 14px; text-align:left; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Loja</th>
                            <th style="padding:10px 14px; text-align:center; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Itens</th>
                            <th style="padding:10px 14px; text-align:right; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Receita</th>
                            <th style="padding:10px 14px; text-align:right; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Custo</th>
                            <th style="padding:10px 14px; text-align:right; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Lucro</th>
                            <th style="padding:10px 14px; text-align:center; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); border-bottom:2px solid var(--border);">Download</th>
                        </tr>
                    </thead>
                    <tbody>${rowsLojas}</tbody>
                </table>
            </div>
        </div>`;
    }

    el.innerHTML = `
    <div class="card">
        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
            <span class="card-title"><i class="fas fa-calculator"></i> Resumo de Lucro</span>
            <button class="btn btn-primary btn-sm" onclick="baixarArquivo('/api/download-lucro', 'Relatorio_Lucro.zip')">
                <i class="fas fa-download"></i> Baixar ZIP (todas as lojas)
            </button>
        </div>
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:16px; margin-top:12px;">
            <div style="text-align:center; padding:12px; background:var(--bg-input); border-radius:var(--radius-sm);">
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Total Itens</div>
                <div style="font-size:20px; font-weight:700;">${data.total_itens}</div>
            </div>
            <div style="text-align:center; padding:12px; background:var(--bg-input); border-radius:var(--radius-sm);">
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Receita</div>
                <div style="font-size:20px; font-weight:700; color:var(--info);">R$ ${data.receita_total.toFixed(2)}</div>
            </div>
            <div style="text-align:center; padding:12px; background:var(--bg-input); border-radius:var(--radius-sm);">
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Custo Total</div>
                <div style="font-size:20px; font-weight:700; color:var(--warning);">R$ ${data.custo_total.toFixed(2)}</div>
            </div>
            <div style="text-align:center; padding:12px; background:var(--bg-input); border-radius:var(--radius-sm);">
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:4px;">Lucro Total</div>
                <div style="font-size:20px; font-weight:700; color:${corLucro};">R$ ${data.lucro_total.toFixed(2)}</div>
            </div>
        </div>
        ${alertaCusto}
        ${tabelaLojas}
    </div>`;
}

// ================================================================
// AJUDA / TUTORIAL
// ================================================================
function mostrarAjuda(topico) {
    const ajudas = {
        upload: {
            titulo: 'Como fazer Upload de Arquivos',
            icone: 'fa-upload',
            conteudo: `
                <ol>
                    <li>Clique na area de upload ou arraste seus arquivos para ela</li>
                    <li>Envie os <strong>PDFs</strong> das etiquetas geradas pela Shopee</li>
                    <li>Envie os <strong>XLSX</strong> de empacotamento da Shopee (contem produtos e tracking)</li>
                </ol>
                <div class="destaque">
                    <strong>Dica:</strong> Voce pode enviar varios arquivos de uma vez! Os PDFs contem as etiquetas e os XLSX contem os dados de produtos que serao usados para identificar lojas e montar a tabela de produtos.
                </div>
                <p>Apos o upload, seus arquivos apareceram na aba <strong>Arquivos</strong> e estarao prontos para processamento.</p>
            `
        },
        processar: {
            titulo: 'Como Processar Etiquetas',
            icone: 'fa-rocket',
            conteudo: `
                <ol>
                    <li>Primeiro, faca upload dos <strong>PDFs</strong> (etiquetas) e <strong>XLSX</strong> (empacotamento)</li>
                    <li>Clique em <strong>"Iniciar Processamento"</strong></li>
                    <li>O sistema ira automaticamente:
                        <ul>
                            <li>Ler os XLSX para identificar produtos e tracking</li>
                            <li>Recortar cada etiqueta do PDF</li>
                            <li>Adicionar informacoes do produto (SKU e quantidade) em cada etiqueta</li>
                            <li>Separar por loja e gerar um PDF por loja</li>
                            <li>Gerar um resumo XLSX com todos os SKUs e quantidades</li>
                        </ul>
                    </li>
                    <li>Acompanhe o progresso na aba <strong>Logs</strong></li>
                    <li>Baixe os resultados na aba <strong>Resultados</strong></li>
                </ol>
                <div class="destaque">
                    <strong>Importante:</strong> Cada loja tera sua propria pasta com PDF de etiquetas e planilha XLSX de resumo.
                </div>
            `
        },
        lucro: {
            titulo: 'Como funciona o Resumo de Lucro',
            icone: 'fa-dollar-sign',
            conteudo: `
                <ol>
                    <li>Va em <strong>Configuracoes > Calculadora de Lucro</strong></li>
                    <li>Faca upload da sua <strong>planilha de custos</strong> (.xlsx) com:
                        <ul>
                            <li>Coluna A = SKU do produto</li>
                            <li>Coluna B = Custo unitario</li>
                        </ul>
                    </li>
                    <li>Configure os parametros: taxa Shopee, aliquota, custo fixo, etc.</li>
                    <li>Processe as etiquetas normalmente</li>
                    <li>Clique em <strong>"Resumo de Lucro"</strong></li>
                </ol>
                <p>O sistema calcula para cada item:</p>
                <p><strong>Lucro = Valor Real - Aliquota - Taxa Shopee - Custo Fixo - Custo Produto</strong></p>
                <div class="destaque">
                    <strong>Busca inteligente de SKU:</strong> O sistema primeiro busca o SKU exato na planilha. Se nao encontrar, busca pelo maior prefixo correspondente. Ex: se sua planilha tem "ABC" e o XML tem "ABC123", o sistema encontra o custo!
                </div>
                <p>Voce pode baixar um <strong>exemplo de planilha</strong> em Configuracoes > Calculadora de Lucro > "Baixar Exemplo".</p>
            `
        },
        calculadora: {
            titulo: 'Configuracao da Calculadora de Lucro',
            icone: 'fa-calculator',
            conteudo: `
                <p>Configure os parametros usados no calculo de lucro:</p>
                <ul>
                    <li><strong>% Valor Declarado:</strong> Percentual do valor total declarado na NF (padrao: 100%)</li>
                    <li><strong>Taxa Shopee:</strong> Percentual cobrado pela Shopee sobre o valor real (padrao: 18%)</li>
                    <li><strong>Aliquota:</strong> Percentual de imposto sobre o valor declarado (padrao: 4%)</li>
                    <li><strong>Custo Fixo:</strong> Custo fixo por unidade vendida, ex: embalagem (padrao: R$ 3,00)</li>
                </ul>
                <div class="destaque">
                    <strong>Planilha de Custos:</strong> Faca upload de um arquivo .xlsx com Coluna A = SKU e Coluna B = Custo unitario. Clique em "Baixar Exemplo" para ver o formato correto.
                </div>
                <p><strong>Configuracao por loja:</strong> Apos processar etiquetas, voce pode definir parametros diferentes para cada loja na secao abaixo.</p>
            `
        },
    };

    const ajuda = ajudas[topico];
    if (!ajuda) return;

    let modal = document.getElementById('modalAjuda');
    if (modal) modal.remove();

    modal = document.createElement('div');
    modal.id = 'modalAjuda';
    modal.className = 'modal-ajuda';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    modal.innerHTML = `
        <div class="modal-ajuda-content">
            <h3><i class="fas ${ajuda.icone}"></i> ${ajuda.titulo}</h3>
            ${ajuda.conteudo}
            <div style="text-align:center; margin-top:16px;">
                <button onclick="document.getElementById('modalAjuda').remove()" class="btn btn-primary btn-sm">
                    <i class="fas fa-check"></i> Entendi
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ================================================================
// INIT
// ================================================================
// Auto-save config com debounce
let _autoSaveTimer = null;
function autoSaveConfig() {
    if (_autoSaveTimer) clearTimeout(_autoSaveTimer);
    _autoSaveTimer = setTimeout(() => {
        salvarConfig();
    }, 1000);
}

async function init() {
    // Verificar se esta logado
    if (!getToken()) {
        window.location.href = '/login';
        return;
    }

    await atualizarStatus();
    await atualizarLogs();

    // Auto-save: salvar configuracoes automaticamente quando alterar qualquer campo
    const cfgIds = [
        'cfgLargura', 'cfgAltura', 'cfgMargemEsq', 'cfgMargemDir',
        'cfgMargemTopo', 'cfgMargemInf', 'cfgFonteProduto', 'cfgExibicaoProduto',
        'cfgPercDeclarado', 'cfgTaxaShopee', 'cfgImpostoSimples', 'cfgCustoFixo'
    ];
    cfgIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', autoSaveConfig);
            el.addEventListener('input', autoSaveConfig);
        }
    });

    // Polling normal
    pollingInterval = setInterval(() => {
        atualizarStatus();
        atualizarLogs();
    }, 5000);
}

init();

// ================================================================
// ADMIN
// ================================================================
let _isAdmin = false;

async function verificarAdmin() {
    if (_isAdmin) return;
    const res = await fetchAPI('/api/admin/check');
    if (res && res.is_admin) {
        _isAdmin = true;
        document.getElementById('navAdmin').style.display = '';
    }
}

async function adminCarregarUsuarios() {
    const res = await fetchAPI('/api/admin/usuarios');
    if (!res || !res.usuarios) return;
    const el = document.getElementById('adminListaUsuarios');
    const usuarios = res.usuarios;

    let html = `<table style="width:100%; border-collapse:collapse; font-size:12px;">
        <thead><tr style="background:var(--bg-input);">
            <th style="padding:8px; text-align:left;">Email</th>
            <th style="padding:8px; text-align:center;">Plano</th>
            <th style="padding:8px; text-align:center;">Expira</th>
            <th style="padding:8px; text-align:center;">Bonus</th>
            <th style="padding:8px; text-align:center;">Cadastro</th>
            <th style="padding:8px; text-align:center;">Acao</th>
        </tr></thead><tbody>`;

    for (const u of usuarios) {
        const planoCor = u.plano === 'free' ? '#a78bfa' : '#22c55e';
        let expiraHtml = '-';
        if (u.plano_expira === 'Vitalicio') {
            expiraHtml = '<span style="color:#f59e0b; font-weight:600;">&#9733; Vitalicio</span>';
        } else if (u.plano_expira === 'Sem expiracao') {
            expiraHtml = '<span style="color:#22c55e;">Ativo</span>';
        } else if (u.plano_expira) {
            expiraHtml = u.plano_expira;
        }
        html += `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:6px 8px; font-size:12px;">${u.email}${u.vitalicio ? ' <i class="fas fa-crown" style="color:#f59e0b; font-size:10px;" title="Admin"></i>' : ''}</td>
            <td style="padding:6px; text-align:center;"><span style="padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600; background:${u.plano === 'free' ? '#2d1b4e' : '#1b2d1b'}; color:${planoCor};">${u.plano_nome}</span></td>
            <td style="padding:6px; text-align:center; font-size:11px;">${expiraHtml}</td>
            <td style="padding:6px; text-align:center; font-size:11px; color:var(--accent);">${u.meses_gratis > 0 ? u.meses_gratis + ' mes(es)' : '-'}</td>
            <td style="padding:6px; text-align:center; font-size:11px; color:var(--text-muted);">${u.created_at}</td>
            <td style="padding:6px; text-align:center;">
                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('adminEmail').value='${u.email}'" style="font-size:10px; padding:2px 8px;">Selecionar</button>
            </td>
        </tr>`;
    }
    html += '</tbody></table>';
    html += `<div style="margin-top:8px; font-size:11px; color:var(--text-muted);">${usuarios.length} usuario(s) cadastrado(s)</div>`;
    el.innerHTML = html;
}

async function adminLiberarAcesso() {
    const email = document.getElementById('adminEmail').value.trim();
    const plano = document.getElementById('adminPlano').value;
    const meses = parseInt(document.getElementById('adminMeses').value) || 1;

    if (!email) { toast('Digite o email', 'warning'); return; }

    const res = await fetchAPI('/api/admin/liberar-acesso', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, plano, meses }),
    });
    if (res && res.mensagem) {
        toast(res.mensagem, 'success');
        adminCarregarUsuarios();
    } else {
        toast(res?.erro || 'Erro ao liberar acesso', 'error');
    }
}

async function adminRevogarAcesso() {
    const email = document.getElementById('adminEmail').value.trim();
    if (!email) { toast('Digite o email', 'warning'); return; }

    const res = await fetchAPI('/api/admin/revogar-acesso', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
    });
    if (res && res.mensagem) {
        toast(res.mensagem, 'success');
        adminCarregarUsuarios();
    } else {
        toast(res?.erro || 'Erro ao revogar acesso', 'error');
    }
}

// ================================================================
// AUTOMACAO - UpSeller + WhatsApp + Agendamentos
// ================================================================

async function carregarDadosAutomacao() {
    carregarUpsellerConfig();
    verificarWhatsApp();
    carregarContatos();
    carregarAgendamentos();
    carregarHistorico();
}

// --- UPSELLER ---
async function carregarUpsellerConfig() {
    const data = await fetchAPI('/api/upseller/status');
    const statusEl = document.getElementById('upsellerStatus');
    const syncEl = document.getElementById('upsellerUltimaSync');
    const divOff = document.getElementById('upsellerDesconectado');
    const divOn = document.getElementById('upsellerConectado');
    if (data && data.status === 'ok') {
        statusEl.textContent = 'Conectado';
        statusEl.style.background = '#25D366';
        divOff.style.display = 'none';
        divOn.style.display = 'block';
    } else {
        statusEl.textContent = 'Desconectado';
        statusEl.style.background = '#e74c3c';
        divOff.style.display = 'block';
        divOn.style.display = 'none';
    }
    if (data && data.ultima_sincronizacao) {
        syncEl.textContent = 'Ultima sincronizacao: ' + data.ultima_sincronizacao;
    } else {
        syncEl.textContent = '';
    }
}

async function conectarUpseller() {
    toast('Abrindo UpSeller... Faca login na janela que vai aparecer.', 'info');
    const res = await fetchAPI('/api/upseller/conectar', { method: 'POST' });
    if (res && res.status === 'ok') {
        toast(res.mensagem || 'Conectado ao UpSeller!', 'success');
        carregarUpsellerConfig();
    } else {
        toast(res?.erro || 'Conexao nao concluida', 'error');
    }
}

async function reconectarUpseller() {
    toast('Reconectando ao UpSeller...', 'info');
    const res = await fetchAPI('/api/upseller/reconectar', { method: 'POST' });
    if (res && res.status === 'ok') {
        toast(res.mensagem || 'Reconectado ao UpSeller!', 'success');
        carregarUpsellerConfig();
    } else {
        toast(res?.erro || 'Nao foi possivel reconectar. Tente Conectar novamente.', 'warning');
        carregarUpsellerConfig();
    }
}

async function testarUpsellerConexao() {
    toast('Verificando sessao do UpSeller...', 'info');
    const res = await fetchAPI('/api/upseller/testar-conexao', { method: 'POST' });
    if (res && res.status === 'ok') {
        toast('Sessao ativa!', 'success');
        carregarUpsellerConfig();
    } else {
        toast(res?.erro || 'Sessao expirada. Clique em "Reconectar".', 'warning');
        carregarUpsellerConfig();
    }
}

let _syncPollInterval = null;

async function sincronizarUpseller() {
    const btn = document.getElementById('btnSincronizar');
    const progressContainer = document.getElementById('syncProgressContainer');
    const progressBar = document.getElementById('syncProgressBar');
    const progressPercent = document.getElementById('syncProgressPercent');
    const progressText = document.getElementById('syncProgressText');

    // Desabilitar botao
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando...';

    // Mostrar barra de progresso
    progressContainer.style.display = 'block';
    progressBar.style.width = '5%';
    progressPercent.textContent = '';
    progressText.textContent = 'Iniciando sincronizacao...';

    const res = await fetchAPI('/api/upseller/sincronizar', { method: 'POST' });
    if (!res || res.erro) {
        toast(res?.erro || 'Erro ao iniciar sincronizacao', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar Agora';
        progressContainer.style.display = 'none';
        return;
    }

    toast('Sincronizacao iniciada!', 'info');

    // Polling de progresso a cada 2 segundos
    if (_syncPollInterval) clearInterval(_syncPollInterval);
    _syncPollInterval = setInterval(async () => {
        try {
            const status = await fetchAPI('/api/upseller/sincronizar/status');
            if (!status) return;

            const progresso = status.progresso || 0;
            progressBar.style.width = Math.max(progresso, 5) + '%';
            progressPercent.textContent = progresso + '%';
            progressText.textContent = status.detalhes || status.etapa || '';

            // Mudar cor baseado na etapa
            if (status.etapa === 'concluido') {
                progressBar.style.background = 'linear-gradient(90deg, #25D366, #128C7E)';
                progressText.textContent = ' ' + (status.detalhes || 'Concluido!');
                _finalizarSync(btn, progressContainer, true);
            } else if (status.etapa === 'erro') {
                progressBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                progressText.textContent = ' ' + (status.detalhes || 'Erro');
                _finalizarSync(btn, progressContainer, false);
            } else if (status.etapa === 'parcial') {
                progressBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                progressText.textContent = ' ' + (status.detalhes || 'Parcial');
                _finalizarSync(btn, progressContainer, false);
            } else if (!status.em_andamento && progresso === 0 && status.etapa === 'idle') {
                // Ja terminou antes do primeiro poll
                _finalizarSync(btn, progressContainer, true);
            }
        } catch (e) {
            console.error('Erro ao checar progresso:', e);
        }
    }, 2000);
}

async function _finalizarSync(btn, progressContainer, sucesso) {
    if (_syncPollInterval) {
        clearInterval(_syncPollInterval);
        _syncPollInterval = null;
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Sincronizar Agora';

    if (sucesso) {
        toast('Sincronizacao concluida! Escolha as lojas para gerar envio.', 'success');
        // Buscar resultado final com lojas pendentes
        try {
            const statusFinal = await fetchAPI('/api/upseller/sincronizar/status');
            if (statusFinal) {
                const lojas = statusFinal.lojas_encontradas || [];
                const totalPedidos = statusFinal.total_pedidos || 0;
                const sidebarInfo = statusFinal.sidebar_info || {};
                _renderPainelLojas(lojas, totalPedidos, statusFinal.detalhes, sidebarInfo);
            }
        } catch (e) {
            console.error('Erro ao buscar resultado final:', e);
        }
    }

    // Esconder barra apos 3 segundos
    setTimeout(() => {
        progressContainer.style.display = 'none';
        document.getElementById('syncProgressBar').style.background = 'linear-gradient(90deg, #2196F3, #1565C0)';
    }, 3000);

    // Atualizar status
    carregarUpsellerConfig();
}

let _syncGruposAutomacao = []; // Grupos criados na aba automacao

function _renderPainelLojas(lojas, totalPedidos, detalhes, sidebarInfo) {
    // Remover painel anterior se existir
    const existente = document.getElementById('syncResultadoPanel');
    if (existente) existente.remove();

    const totalLojas = lojas.length;
    sidebarInfo = sidebarInfo || {};

    // ===== CARDS DE ATALHOS DO UPSELLER (sidebar) =====
    const atalhos = [
        { key: 'Para Emitir',   icon: 'fa-file-invoice',  color: '#f39c12', bg: 'rgba(243,156,18,0.12)' },
        { key: 'Para Enviar',   icon: 'fa-shipping-fast',  color: '#2196F3', bg: 'rgba(33,150,243,0.12)' },
        { key: 'Para Imprimir', icon: 'fa-print',          color: '#25D366', bg: 'rgba(37,211,102,0.12)' },
    ];
    let atalhosHTML = atalhos.map(a => {
        const valor = sidebarInfo[a.key] ?? '-';
        const isActive = typeof valor === 'number' && valor > 0;
        return `<div style="
            flex:1; min-width:120px; padding:12px 14px; border-radius:10px;
            background:${isActive ? a.bg : 'var(--bg-input)'};
            border:1px solid ${isActive ? a.color + '44' : 'var(--border)'};
            text-align:center; transition:all 0.2s;
        ">
            <div style="font-size:20px; color:${isActive ? a.color : 'var(--text-muted)'}; margin-bottom:4px;">
                <i class="fas ${a.icon}"></i>
            </div>
            <div style="font-size:22px; font-weight:700; color:${isActive ? a.color : 'var(--text-muted)'};">${valor}</div>
            <div style="font-size:10px; color:var(--text-secondary); font-weight:600; text-transform:uppercase; letter-spacing:0.5px;">${a.key}</div>
        </div>`;
    }).join('');

    // Checkboxes de lojas
    let lojasCheckHTML = '';
    if (lojas.length > 0) {
        lojasCheckHTML = lojas.map(l => {
            const pedidos = l.pedidos || 0;
            const nome = l.nome || 'Desconhecida';
            const marketplace = l.marketplace || '';
            return `<label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border-bottom:1px solid var(--border);cursor:pointer;font-size:12px;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" class="sync-loja-check" data-nome="${nome}" checked>
                <i class="fas fa-store" style="color:var(--text-muted);"></i>
                <span style="flex:1;font-weight:500;">${nome}</span>
                ${marketplace ? `<span style="background:var(--bg-tertiary);color:var(--text-muted);padding:1px 4px;border-radius:4px;font-size:9px;">${marketplace}</span>` : ''}
                <span style="background:#2196F3;color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;">${pedidos} pedido${pedidos !== 1 ? 's' : ''}</span>
            </label>`;
        }).join('');
    }

    // Grupos salvos HTML
    let gruposSalvosHTML = '';
    if (_syncGruposAutomacao.length > 0) {
        gruposSalvosHTML = _syncGruposAutomacao.map((g, i) => `
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;">
                <i class="fas fa-layer-group" style="color:var(--primary);"></i>
                <div style="flex:1;">
                    <div style="font-size:12px;font-weight:600;">${g.nome}</div>
                    <div style="font-size:10px;color:var(--text-muted);">${g.nomes_lojas.join(', ')}</div>
                </div>
                <button onclick="_removerGrupoSync(${i})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;" title="Remover grupo"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    }

    const panel = document.createElement('div');
    panel.id = 'syncResultadoPanel';
    panel.style.cssText = 'margin-top:15px; border:1px solid var(--border); border-radius:8px; overflow:hidden; background:var(--bg-primary);';
    panel.innerHTML = `
        <div style="background:linear-gradient(135deg, ${totalPedidos > 0 ? '#2196F3, #1565C0' : '#f39c12, #e67e22'}); color:#fff; padding:10px 15px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:600; font-size:13px;">
                <i class="fas fa-${totalPedidos > 0 ? 'store' : 'exclamation-circle'}"></i>
                ${totalPedidos > 0 ? `${totalLojas} Loja${totalLojas !== 1 ? 's' : ''} - ${totalPedidos} pedido${totalPedidos !== 1 ? 's' : ''} pendente${totalPedidos !== 1 ? 's' : ''}` : 'Nenhum pedido pendente encontrado'}
            </span>
            <button onclick="this.closest('#syncResultadoPanel').remove()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;">&times;</button>
        </div>

        <!-- Atalhos do UpSeller (sidebar counts) -->
        <div style="display:flex;gap:10px;padding:12px 15px;flex-wrap:wrap;">
            ${atalhosHTML}
        </div>

        ${totalPedidos > 0 ? `
        <div style="padding:0 15px 12px 15px;">
            <!-- Lojas com checkboxes -->
            <div style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;">
                        <i class="fas fa-check-square"></i> Selecione as lojas para processar:
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="_toggleTodasLojas(true)" style="font-size:10px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:2px 6px;cursor:pointer;color:var(--text-secondary);">Todas</button>
                        <button onclick="_toggleTodasLojas(false)" style="font-size:10px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:2px 6px;cursor:pointer;color:var(--text-secondary);">Nenhuma</button>
                    </div>
                </div>
                <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;">
                    ${lojasCheckHTML}
                </div>
            </div>

            <!-- Agrupamento -->
            <div style="margin-bottom:12px; border:1px solid var(--border); border-radius:6px; padding:10px;">
                <div style="font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;">
                    <i class="fas fa-layer-group"></i> Agrupamento de Lojas (opcional)
                </div>
                <div id="syncGruposSalvos">${gruposSalvosHTML}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-bottom:6px;">Selecione 2+ lojas acima e crie um grupo para gerar PDF unificado:</div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <input id="syncGrupoNome" class="form-input" type="text" placeholder="Nome do grupo" style="font-size:11px;flex:1;padding:4px 8px;">
                    <button onclick="_adicionarGrupoSync()" class="btn btn-primary" style="font-size:11px;padding:4px 10px;white-space:nowrap;">
                        <i class="fas fa-plus"></i> Criar Grupo
                    </button>
                </div>
            </div>

            <!-- Botao Gerar -->
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button onclick="_gerarEnvio()" class="btn btn-primary" style="font-size:13px;padding:8px 20px;flex:1;background:linear-gradient(135deg, #25D366, #128C7E);">
                    <i class="fas fa-rocket"></i> Gerar Envio
                </button>
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:6px;text-align:center;">
                ${detalhes || ''}
            </div>
        </div>
        ` : `
        <div style="padding:0 15px 12px 15px;">
            <div style="background:var(--bg-secondary);border:1px solid var(--border);border-radius:6px;padding:10px 12px;">
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                    <i class="fas fa-check-circle" style="color:#25D366;"></i>
                    <b>Nenhum pedido pendente no UpSeller.</b> Todos os pedidos ja foram processados ou nao ha novos pedidos.
                </div>
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:6px;text-align:right;">${detalhes || ''}</div>
        </div>
        `}
    `;

    // Inserir painel
    const upsellerCard = document.getElementById('upsellerConectado');
    if (upsellerCard && upsellerCard.closest('.card')) {
        upsellerCard.closest('.card').appendChild(panel);
    }
}

function _toggleTodasLojas(marcar) {
    document.querySelectorAll('.sync-loja-check').forEach(cb => cb.checked = marcar);
}

function _adicionarGrupoSync() {
    const nome = document.getElementById('syncGrupoNome').value.trim();
    const checked = document.querySelectorAll('.sync-loja-check:checked');
    if (checked.length < 2) {
        toast('Selecione 2 ou mais lojas para criar um grupo', 'warning');
        return;
    }
    if (!nome) {
        toast('Informe um nome para o grupo', 'warning');
        return;
    }

    const cnpjs = Array.from(checked).map(c => c.dataset.cnpj);
    const nomes_lojas = Array.from(checked).map(c => c.dataset.nome);

    _syncGruposAutomacao.push({ nome, cnpjs, nomes_lojas });

    // Salvar no backend (reusa o endpoint de agrupamentos)
    fetchAPI('/api/agrupamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agrupamentos: _syncGruposAutomacao })
    });

    // Atualizar UI
    document.getElementById('syncGrupoNome').value = '';
    const container = document.getElementById('syncGruposSalvos');
    if (container) {
        container.innerHTML = _syncGruposAutomacao.map((g, i) => `
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;">
                <i class="fas fa-layer-group" style="color:var(--primary);"></i>
                <div style="flex:1;">
                    <div style="font-size:12px;font-weight:600;">${g.nome}</div>
                    <div style="font-size:10px;color:var(--text-muted);">${g.nomes_lojas.join(', ')}</div>
                </div>
                <button onclick="_removerGrupoSync(${i})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    }
    toast(`Grupo "${nome}" criado com ${cnpjs.length} lojas`, 'success');
}

function _removerGrupoSync(index) {
    _syncGruposAutomacao.splice(index, 1);
    fetchAPI('/api/agrupamentos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ agrupamentos: _syncGruposAutomacao })
    });
    // Re-render
    const panel = document.getElementById('syncResultadoPanel');
    if (panel) {
        const container = document.getElementById('syncGruposSalvos');
        if (container) {
            container.innerHTML = _syncGruposAutomacao.map((g, i) => `
                <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;margin-bottom:4px;">
                    <i class="fas fa-layer-group" style="color:var(--primary);"></i>
                    <div style="flex:1;">
                        <div style="font-size:12px;font-weight:600;">${g.nome}</div>
                        <div style="font-size:10px;color:var(--text-muted);">${g.nomes_lojas.join(', ')}</div>
                    </div>
                    <button onclick="_removerGrupoSync(${i})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }
    }
}

async function _gerarEnvio() {
    // Salvar agrupamentos antes de gerar
    if (_syncGruposAutomacao.length > 0) {
        await fetchAPI('/api/agrupamentos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agrupamentos: _syncGruposAutomacao })
        });
    }

    // Coletar lojas selecionadas (checkboxes marcados)
    const lojasChecked = document.querySelectorAll('.sync-loja-check:checked');
    const lojasSelecionadas = Array.from(lojasChecked).map(cb => cb.dataset.nome);

    if (lojasChecked.length === 0) {
        toast('Selecione pelo menos uma loja para gerar envio', 'warning');
        return;
    }

    // Chamar o pipeline com lojas selecionadas
    const data = await fetchAPI('/api/upseller/gerar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lojas: lojasSelecionadas })
    });
    if (data && data.erro) {
        toast(data.erro, 'warning');
        return;
    }

    const lojasTexto = lojasSelecionadas.length > 3
        ? `${lojasSelecionadas.slice(0,3).join(', ')}... (${lojasSelecionadas.length} lojas)`
        : lojasSelecionadas.join(', ');
    toast(`Geracao iniciada para: ${lojasTexto}`, 'info');

    // NO remove o painel de lojas - ele persiste para referncia
    // Apenas esconder temporariamente durante a gerao
    const panel = document.getElementById('syncResultadoPanel');
    if (panel) panel.style.opacity = '0.5';

    // Remover painel de resultado anterior se existir
    const oldProc = document.getElementById('syncProcessandoPanel');
    if (oldProc) oldProc.remove();

    // Mostrar progresso inline
    const progressDiv = document.createElement('div');
    progressDiv.id = 'syncProcessandoPanel';
    progressDiv.style.cssText = 'margin-top:15px;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--bg-primary);';
    progressDiv.innerHTML = `
        <div style="background:linear-gradient(135deg, #25D366, #128C7E);color:#fff;padding:10px 15px;">
            <span style="font-weight:600;font-size:13px;"><i class="fas fa-spinner fa-spin"></i> Gerando envio...</span>
        </div>
        <div style="padding:12px 15px;">
            <div id="syncGerarProgress" style="margin-bottom:8px;">
                <div style="background:var(--bg-tertiary);border-radius:8px;overflow:hidden;height:22px;position:relative;">
                    <div id="syncGerarBar" style="height:100%;border-radius:8px;transition:width 0.5s ease;background:linear-gradient(90deg, #25D366, #128C7E);width:5%;display:flex;align-items:center;justify-content:center;">
                        <span id="syncGerarPercent" style="color:white;font-size:10px;font-weight:600;">5%</span>
                    </div>
                </div>
                <p id="syncGerarText" style="font-size:11px;color:var(--text-secondary);margin-top:4px;text-align:center;">Iniciando...</p>
            </div>
        </div>
    `;
    const upsellerCard = document.getElementById('upsellerConectado');
    if (upsellerCard && upsellerCard.closest('.card')) {
        upsellerCard.closest('.card').appendChild(progressDiv);
    }

    // Polling de status da geracao (endpoint SEPARADO do sync)
    const pollGeracao = setInterval(async () => {
        try {
            const status = await fetchAPI('/api/upseller/gerar/status');
            if (!status) return;

            // Atualizar barra de progresso
            const bar = document.getElementById('syncGerarBar');
            const pct = document.getElementById('syncGerarPercent');
            const txt = document.getElementById('syncGerarText');
            if (bar && status.progresso) {
                bar.style.width = Math.max(status.progresso, 5) + '%';
                if (pct) pct.textContent = status.progresso + '%';
            }
            if (txt && status.detalhes) txt.textContent = status.detalhes;

            // Verificar se terminou
            if (status.etapa === 'concluido' || status.etapa === 'parcial') {
                clearInterval(pollGeracao);

                // Restaurar opacidade do painel de lojas
                const syncPanel = document.getElementById('syncResultadoPanel');
                if (syncPanel) syncPanel.style.opacity = '1';

                // Buscar resultado do processamento
                const statusFinal = await fetchAPI('/api/status');
                const procDiv = document.getElementById('syncProcessandoPanel');

                if (procDiv && statusFinal && statusFinal.ultimo_resultado) {
                    const resultado = statusFinal.ultimo_resultado;
                    const lojas = resultado.lojas || [];
                    procDiv.innerHTML = `
                        <div style="background:linear-gradient(135deg, #25D366, #128C7E);color:#fff;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-weight:600;font-size:13px;"><i class="fas fa-check-circle"></i> Envio Gerado com Sucesso!</span>
                            <button onclick="this.closest('#syncProcessandoPanel').remove()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:16px;">&times;</button>
                        </div>
                        <div style="padding:12px 15px;">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin-bottom:12px;">
                                <div style="text-align:center;padding:8px;background:var(--bg-secondary);border-radius:6px;">
                                    <div style="font-size:18px;font-weight:700;color:#25D366;">${resultado.total_etiquetas || 0}</div>
                                    <div style="font-size:10px;color:var(--text-secondary);">Etiquetas</div>
                                </div>
                                <div style="text-align:center;padding:8px;background:var(--bg-secondary);border-radius:6px;">
                                    <div style="font-size:18px;font-weight:700;color:var(--primary);">${resultado.total_lojas || 0}</div>
                                    <div style="font-size:10px;color:var(--text-secondary);">Lojas</div>
                                </div>
                                <div style="text-align:center;padding:8px;background:var(--bg-secondary);border-radius:6px;">
                                    <div style="font-size:18px;font-weight:700;color:var(--text-muted);">${resultado.duracao_s || 0}s</div>
                                    <div style="font-size:10px;color:var(--text-secondary);">Duracao</div>
                                </div>
                            </div>
                            ${lojas.length > 0 ? `
                            <div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;margin-bottom:12px;">
                                ${lojas.map(l => `<div style="display:flex;justify-content:space-between;padding:4px 10px;border-bottom:1px solid var(--border);font-size:12px;">
                                    <span>${l.nome || l.loja || '?'}</span>
                                    <span style="color:#25D366;font-weight:600;">${l.etiquetas || 0} etiquetas</span>
                                </div>`).join('')}
                            </div>` : ''}
                            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                <button class="btn btn-success" onclick="enviarWhatsAppManual()" style="font-size:11px;padding:6px 12px;">
                                    <i class="fab fa-whatsapp"></i> Enviar via WhatsApp
                                </button>
                                <button class="btn btn-secondary" onclick="baixarArquivo('/api/download-todos','Etiquetas_prontas.zip')" style="font-size:11px;padding:6px 12px;">
                                    <i class="fas fa-download"></i> Baixar ZIP
                                </button>
                            </div>
                        </div>
                    `;
                } else if (procDiv) {
                    procDiv.innerHTML = `
                        <div style="background:linear-gradient(135deg, #f39c12, #e67e22);color:#fff;padding:10px 15px;">
                            <span style="font-weight:600;font-size:13px;"><i class="fas fa-exclamation-circle"></i> ${status.detalhes || 'Geracao concluida com avisos'}</span>
                        </div>
                    `;
                }

                toast(status.etapa === 'concluido' ? 'Envio gerado com sucesso!' : status.detalhes, status.etapa === 'concluido' ? 'success' : 'warning');

            } else if (status.etapa === 'erro') {
                clearInterval(pollGeracao);
                toast(status.detalhes || 'Erro na geracao', 'error');
                const procDiv = document.getElementById('syncProcessandoPanel');
                if (procDiv) procDiv.remove();
                // Restaurar opacidade do painel de lojas
                const syncPanel2 = document.getElementById('syncResultadoPanel');
                if (syncPanel2) syncPanel2.style.opacity = '1';
            }
        } catch (e) {
            console.error('Erro polling geracao:', e);
        }
    }, 2000);
}

// --- WHATSAPP ---
let _whatsappQRPolling = null;

async function verificarWhatsApp() {
    const data = await fetchAPI('/api/whatsapp/status');
    const statusEl = document.getElementById('whatsappStatus');
    const qrContainer = document.getElementById('whatsappQRContainer');
    if (data && data.connected) {
        statusEl.textContent = `Conectado (${data.phone || ''})`;
        statusEl.style.background = '#25D366';
        // Esconder QR code quando conectado
        if (qrContainer) qrContainer.style.display = 'none';
        // Parar polling se estiver ativo
        _pararPollingQR();
    } else {
        statusEl.textContent = 'Desconectado';
        statusEl.style.background = '#e74c3c';
    }
    return data;
}

function _pararPollingQR() {
    if (_whatsappQRPolling) {
        clearInterval(_whatsappQRPolling);
        _whatsappQRPolling = null;
    }
}

async function mostrarQRWhatsApp() {
    const container = document.getElementById('whatsappQRContainer');

    // Se ja esta conectado, nao mostra QR
    const statusCheck = await fetchAPI('/api/whatsapp/status');
    if (statusCheck && statusCheck.connected) {
        toast('WhatsApp ja esta conectado!', 'success');
        container.style.display = 'none';
        verificarWhatsApp();
        return;
    }

    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    if (container.style.display === 'block') {
        toast('Obtendo QR code... Escaneie com seu WhatsApp', 'info');
        const data = await fetchAPI('/api/whatsapp/qr');
        if (data && data.qr) {
            document.getElementById('whatsappQRImage').src = data.qr;
            // Iniciar polling automatico para detectar conexao
            _iniciarPollingQRWhatsApp();
        } else if (data && data.message && data.message.includes('conectado')) {
            toast('WhatsApp ja esta conectado!', 'success');
            container.style.display = 'none';
            verificarWhatsApp();
        } else {
            // Tentar iniciar sessao automaticamente
            toast('Iniciando sessao WhatsApp...', 'info');
            await fetchAPI('/api/whatsapp/qr'); // Trigger session start
            setTimeout(async () => {
                const retry = await fetchAPI('/api/whatsapp/qr');
                if (retry && retry.qr) {
                    document.getElementById('whatsappQRImage').src = retry.qr;
                    _iniciarPollingQRWhatsApp();
                } else {
                    toast(retry?.error || 'Erro ao obter QR code. Verifique se o servico Baileys esta rodando.', 'error');
                    container.style.display = 'none';
                }
            }, 3000);
        }
    } else {
        _pararPollingQR();
    }
}

function _iniciarPollingQRWhatsApp() {
    _pararPollingQR(); // Limpar polling anterior
    let tentativas = 0;
    const maxTentativas = 60; // 2 minutos (60 x 2s)

    _whatsappQRPolling = setInterval(async () => {
        tentativas++;
        if (tentativas > maxTentativas) {
            _pararPollingQR();
            toast('Tempo esgotado. Clique em "Ver QR Code" novamente.', 'warning');
            document.getElementById('whatsappQRContainer').style.display = 'none';
            return;
        }

        try {
            // Verificar se conectou
            const status = await fetchAPI('/api/whatsapp/status');
            if (status && status.connected) {
                _pararPollingQR();
                document.getElementById('whatsappQRContainer').style.display = 'none';
                toast('WhatsApp conectado com sucesso!', 'success');
                verificarWhatsApp();
                return;
            }

            // Atualizar QR code a cada 10s (pode mudar)
            if (tentativas % 5 === 0) {
                const qrData = await fetchAPI('/api/whatsapp/qr');
                if (qrData && qrData.qr) {
                    document.getElementById('whatsappQRImage').src = qrData.qr;
                }
            }
        } catch (e) {
            console.error('Erro no polling QR WhatsApp:', e);
        }
    }, 2000);
}

async function enviarTesteWhatsApp() {
    const tel = document.getElementById('whatsappTesteTel').value;
    if (!tel) { toast('Informe um numero', 'warning'); return; }
    const res = await fetchAPI('/api/whatsapp/enviar-teste', {
        method: 'POST', body: JSON.stringify({ telefone: tel })
    });
    if (res && res.success) toast('Mensagem de teste enviada!', 'success');
    else toast(res?.error || 'Erro ao enviar teste', 'error');
}

// --- CONTATOS ---
function mostrarFormContato() {
    document.getElementById('formContato').style.display = 'block';
    document.getElementById('contatoCNPJ').value = '';
    document.getElementById('contatoLoja').value = '';
    document.getElementById('contatoTel').value = '';
    document.getElementById('contatoNome').value = '';
}

async function salvarContato() {
    const cnpj = document.getElementById('contatoCNPJ').value;
    const loja = document.getElementById('contatoLoja').value;
    const tel = document.getElementById('contatoTel').value;
    const nome = document.getElementById('contatoNome').value;
    if (!cnpj || !tel) { toast('CNPJ e telefone obrigatorios', 'warning'); return; }
    const res = await fetchAPI('/api/whatsapp/contatos', {
        method: 'POST',
        body: JSON.stringify({ loja_cnpj: cnpj, loja_nome: loja, telefone: tel, nome_contato: nome })
    });
    if (res && !res.erro) {
        toast('Contato salvo!', 'success');
        document.getElementById('formContato').style.display = 'none';
        carregarContatos();
    } else toast(res?.erro || 'Erro', 'error');
}

async function carregarContatos() {
    const data = await fetchAPI('/api/whatsapp/contatos');
    const container = document.getElementById('tabelaContatos');
    if (!data || data.length === 0) {
        container.innerHTML = '<p style="font-size:12px; color:var(--text-secondary);">Nenhum contato cadastrado.</p>';
        return;
    }
    let html = '<table style="width:100%; font-size:12px;"><thead><tr>';
    html += '<th>Loja</th><th>CNPJ</th><th>WhatsApp</th><th>Contato</th><th>Ativo</th><th></th>';
    html += '</tr></thead><tbody>';
    data.forEach(c => {
        html += `<tr>
            <td>${c.loja_nome}</td>
            <td style="font-size:11px;">${c.loja_cnpj}</td>
            <td>${c.telefone}</td>
            <td>${c.nome_contato}</td>
            <td>${c.ativo ? '<span style="color:#25D366;">&#10003;</span>' : '<span style="color:#e74c3c;">&#10007;</span>'}</td>
            <td><button class="btn btn-secondary" onclick="removerContato(${c.id})" style="font-size:10px; padding:2px 6px;" title="Remover"><i class="fas fa-trash"></i></button></td>
        </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function removerContato(id) {
    if (!confirm('Remover este contato?')) return;
    const res = await fetchAPI(`/api/whatsapp/contatos/${id}`, { method: 'DELETE' });
    if (res && !res.erro) { toast('Contato removido', 'success'); carregarContatos(); }
    else toast(res?.erro || 'Erro', 'error');
}

// --- AGENDAMENTOS ---
function mostrarFormAgendamento() {
    document.getElementById('formAgendamento').style.display = 'block';
    document.getElementById('agendNome').value = '';
    document.getElementById('agendHora').value = '08:00';
}

async function salvarAgendamento() {
    const nome = document.getElementById('agendNome').value || 'Agendamento';
    const hora = document.getElementById('agendHora').value;
    const dias = Array.from(document.querySelectorAll('.agendDia:checked')).map(cb => cb.value).join(',') || 'todos';
    const res = await fetchAPI('/api/agendamentos', {
        method: 'POST',
        body: JSON.stringify({
            nome, hora, dias_semana: dias,
            baixar_upseller: document.getElementById('agendUpseller').checked,
            processar_etiquetas: document.getElementById('agendProcessar').checked,
            enviar_whatsapp: document.getElementById('agendWhatsapp').checked,
        })
    });
    if (res && !res.erro) {
        toast('Agendamento criado!', 'success');
        document.getElementById('formAgendamento').style.display = 'none';
        carregarAgendamentos();
    } else toast(res?.erro || 'Erro', 'error');
}

async function carregarAgendamentos() {
    const data = await fetchAPI('/api/agendamentos');
    const container = document.getElementById('tabelaAgendamentos');
    if (!data || data.length === 0) {
        container.innerHTML = '<p style="font-size:12px; color:var(--text-secondary);">Nenhum agendamento configurado.</p>';
        return;
    }
    let html = '<table style="width:100%; font-size:12px;"><thead><tr>';
    html += '<th>Nome</th><th>Horario</th><th>Dias</th><th>Proxima</th><th>Ultimo</th><th>Status</th><th></th>';
    html += '</tr></thead><tbody>';
    data.forEach(s => {
        const statusColor = s.ultimo_status === 'sucesso' ? '#25D366' : s.ultimo_status === 'erro' ? '#e74c3c' : s.ultimo_status === 'parcial' ? '#f39c12' : 'var(--text-secondary)';
        const ativoIcon = s.ativo ? '&#9654;' : '&#9646;&#9646;';
        html += `<tr>
            <td>${s.nome}</td>
            <td>${s.hora}</td>
            <td style="font-size:10px;">${s.dias_semana}</td>
            <td style="font-size:10px;">${s.proxima_execucao || '-'}</td>
            <td style="font-size:10px;">${s.ultima_execucao || '-'}</td>
            <td><span style="color:${statusColor}; font-weight:bold;">${s.ultimo_status || '-'}</span></td>
            <td style="white-space:nowrap;">
                <button class="btn btn-secondary" onclick="${s.ativo ? `pausarAgendamento(${s.id})` : `retomarAgendamento(${s.id})`}" style="font-size:10px; padding:2px 6px;" title="${s.ativo ? 'Pausar' : 'Retomar'}">${ativoIcon}</button>
                <button class="btn btn-secondary" onclick="removerAgendamento(${s.id})" style="font-size:10px; padding:2px 6px;" title="Remover"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function pausarAgendamento(id) {
    const res = await fetchAPI(`/api/agendamentos/${id}/pausar`, { method: 'POST' });
    if (res && !res.erro) { toast('Agendamento pausado', 'info'); carregarAgendamentos(); }
    else toast(res?.erro || 'Erro', 'error');
}

async function retomarAgendamento(id) {
    const res = await fetchAPI(`/api/agendamentos/${id}/retomar`, { method: 'POST' });
    if (res && !res.erro) { toast('Agendamento retomado', 'success'); carregarAgendamentos(); }
    else toast(res?.erro || 'Erro', 'error');
}

async function removerAgendamento(id) {
    if (!confirm('Remover este agendamento?')) return;
    const res = await fetchAPI(`/api/agendamentos/${id}`, { method: 'DELETE' });
    if (res && !res.erro) { toast('Agendamento removido', 'success'); carregarAgendamentos(); }
    else toast(res?.erro || 'Erro', 'error');
}

// --- EXECUCAO MANUAL ---
async function executarPipelineAgora() {
    if (!confirm('Executar pipeline completo agora? (UpSeller  Processar  WhatsApp)')) return;
    const res = await fetchAPI('/api/agendamentos/executar-agora', { method: 'POST' });
    if (res && !res.erro) toast('Pipeline iniciado em background!', 'success');
    else toast(res?.erro || 'Erro', 'error');
}

async function enviarWhatsAppManual() {
    if (!confirm('Enviar ultimo resultado via WhatsApp para todos os contatos?')) return;
    const res = await fetchAPI('/api/whatsapp/enviar-lote', { method: 'POST' });
    if (res && !res.erro) toast(res.mensagem || 'Enviando...', 'success');
    else toast(res?.erro || 'Erro', 'error');
}

// --- HISTORICO ---
async function carregarHistorico() {
    const data = await fetchAPI('/api/agendamentos/historico');
    const container = document.getElementById('tabelaHistorico');
    if (!data || data.length === 0) {
        container.innerHTML = '<p style="font-size:12px; color:var(--text-secondary);">Nenhuma execucao registrada.</p>';
        return;
    }
    let html = '<table style="width:100%; font-size:11px;"><thead><tr>';
    html += '<th>Data</th><th>Tipo</th><th>Etiq.</th><th>WA Env.</th><th>WA Err.</th><th>Duracao</th><th>Status</th>';
    html += '</tr></thead><tbody>';
    data.forEach(l => {
        const statusColor = l.status === 'sucesso' ? '#25D366' : l.status === 'erro' ? '#e74c3c' : l.status === 'parcial' ? '#f39c12' : 'var(--text-secondary)';
        html += `<tr>
            <td>${l.inicio}</td>
            <td><span class="badge" style="font-size:9px; padding:1px 5px;">${l.tipo}</span></td>
            <td>${l.etiquetas_processadas}</td>
            <td style="color:#25D366;">${l.whatsapp_enviados}</td>
            <td style="color:#e74c3c;">${l.whatsapp_erros}</td>
            <td>${l.duracao_s ? l.duracao_s.toFixed(0) + 's' : '-'}</td>
            <td><span style="color:${statusColor}; font-weight:bold;">${l.status}</span></td>
        </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}
</script>
</body>
</html>
